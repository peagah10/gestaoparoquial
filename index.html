<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciamento Paroquial - Par√≥quia S√£o Crist√≥v√£o</title>
    
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Open Graph para Instagram, WhatsApp e Facebook -->
    <meta property="og:title" content="Gerenciamento Paroquial - Par√≥quia S√£o Crist√≥v√£o">
    <meta property="og:description" content="Sistema moderno para gest√£o de sacramentos, eventos e membros da Par√≥quia S√£o Crist√≥v√£o. Acesse agora!">
    <meta property="og:image" content="https://gestaoparoquial.netlify.app/images/logo.png">
    <meta property="og:url" content="https://gestaoparoquial.netlify.app"> 
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="Par√≥quia S√£o Crist√≥v√£o">

    <!-- Meta para WhatsApp -->
    <meta name="description" content="Acesse o sistema de gerenciamento paroquial.">
    
    <style>
        :root {
            --primary: #8B0000;
            --secondary: #DC143C;
            --accent: #CD853F;
            --light: #f8fafc;
            --dark: #2d1b1b;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #17a2b8;
            --gold: #FFD700;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(rgba(139, 0, 0, 0.1), rgba(139, 0, 0, 0.05)), 
                        url("images/igreja.jpg") center/cover;
            background-attachment: fixed;
            color: var(--dark);
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Loading Spinner */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(139, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-top: 5px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Novos estilos para bot√µes vermelhos */
        .btn-red {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border: 2px solid var(--primary);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: capitalize;
            letter-spacing: 0.5px;
            margin: 0 5px;
        }

        .btn-red:hover {
            background: linear-gradient(135deg, #A00000, #E6144C);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(139, 0, 0, 0.4);
        }

        .section-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        /* LOGIN PAGE */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, rgba(139, 0, 0, 0.95), rgba(220, 20, 60, 0.9));
            backdrop-filter: blur(8px);
        }

        .login-card {
            background-color: rgba(255, 255, 255, 0.98);
            border-radius: 25px;
            box-shadow: 0 25px 50px rgba(139, 0, 0, 0.4);
            width: 100%;
            max-width: 480px;
            padding: 60px;
            backdrop-filter: blur(20px);
            border: 3px solid rgba(139, 0, 0, 0.2);
            animation: slideIn 0.8s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .login-header {
            text-align: center;
            margin-bottom: 50px;
        }

        .login-header .church-logo {
            width: 120px;
            height: 120px;
            margin: 0 auto 25px;
            border-radius: 50%;
            object-fit: cover;
            box-shadow: 0 10px 30px rgba(139, 0, 0, 0.4);
            border: 4px solid var(--gold);
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .login-header .church-logo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .login-header h1 {
            font-size: 32px;
            color: var(--primary);
            margin-bottom: 10px;
            font-weight: 800;
        }

        .login-header p {
            color: #64748b;
            font-size: 18px;
            font-weight: 500;
        }

        .form-group {
            margin-bottom: 30px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-size: 16px;
            color: var(--dark);
            font-weight: 600;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 18px 22px;
            border: 3px solid #e2e8f0;
            border-radius: 15px;
            font-size: 16px;
            transition: all 0.3s ease;
            background-color: rgba(255, 255, 255, 0.9);
            font-weight: 500;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 6px rgba(139, 0, 0, 0.1);
            background-color: rgba(255, 255, 255, 1);
            transform: translateY(-2px);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 120px;
        }

        .btn {
            display: inline-block;
            padding: 18px 30px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 15px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            text-decoration: none;
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn:disabled {
            background-color: #94a3b8;
            cursor: not-allowed;
            transform: none;
        }

        .btn:disabled:hover {
            background-color: #94a3b8;
            transform: none;
            box-shadow: none;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:hover::before {
            width: 350px;
            height: 350px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #A00000, #E6144C);
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(139, 0, 0, 0.4);
        }

        .btn-block {
            display: block;
            width: 100%;
        }

        .alert {
            padding: 18px 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            font-size: 15px;
            border-left: 5px solid;
            font-weight: 500;
        }

        .alert-danger {
            background-color: #fee2e2;
            color: #b91c1c;
            border-left-color: #ef4444;
        }

        .alert-success {
            background-color: #dcfce7;
            color: #166534;
            border-left-color: #22c55e;
        }

        /* DASHBOARD */
        .dashboard {
            display: none;
        }

        .dashboard.active {
            display: block;
        }

        header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 25px 0;
            box-shadow: 0 6px 25px rgba(139, 0, 0, 0.4);
            backdrop-filter: blur(15px);
            border-bottom: 3px solid var(--gold);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
        }

        .logo .church-logo {
            width: 60px;
            height: 60px;
            margin-right: 18px;
            border-radius: 50%;
            object-fit: cover;
            box-shadow: 0 6px 18px rgba(0,0,0,0.4);
            border: 3px solid var(--gold);
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .logo .church-logo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .logo h1 {
            font-size: 28px;
            font-weight: 800;
        }

        .search-bar {
            flex: 1;
            max-width: 600px;
            margin: 0 40px;
            position: relative;
            display: flex;
            align-items: center;
        }

        .search-bar input {
            flex: 1;
            padding: 15px 25px;
            border: none;
            border-radius: 30px 0 0 30px;
            background-color: rgba(255, 255, 255, 0.15);
            color: white;
            font-size: 16px;
            backdrop-filter: blur(15px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-right: none;
            font-weight: 500;
        }

        .search-btn {
            padding: 17px 25px;
            border: none;
            border-radius: 0 30px 30px 0;
            background-color: rgba(255, 255, 255, 0.25);
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-left: none;
            backdrop-filter: blur(15px);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .search-btn:hover {
            background-color: rgba(255, 255, 255, 0.35);
            transform: translateY(-1px);
        }

        .search-btn img {
            width: 20px;
            height: 20px;
            filter: brightness(0) invert(1);
        }

        .search-bar input::placeholder {
            color: rgba(255, 255, 255, 0.8);
            font-weight: 500;
        }

        .search-bar input:focus {
            outline: none;
            background-color: rgba(255, 255, 255, 0.25);
            box-shadow: 0 0 0 4px rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.4);
        }

        .user-menu {
            display: flex;
            align-items: center;
        }

        .user-menu .avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            margin-right: 15px;
            object-fit: cover;
            box-shadow: 0 6px 18px rgba(255, 215, 0, 0.4);
            border: 2px solid var(--gold);
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .user-menu .avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .user-menu .user-name {
            font-size: 17px;
            margin-right: 20px;
            font-weight: 600;
        }

        .logout-btn {
            background-color: transparent;
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            cursor: pointer;
            font-size: 14px;
            padding: 10px 20px;
            border-radius: 25px;
            transition: all 0.3s ease;
            font-weight: 600;
            text-transform: uppercase;
        }

        .logout-btn:hover {
            background-color: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.6);
            transform: translateY(-1px);
        }

        main {
            padding: 50px 0;
        }

        .welcome-section {
            margin-bottom: 50px;
            background: rgba(255, 255, 255, 0.98);
            padding: 40px;
            border-radius: 25px;
            box-shadow: 0 15px 40px rgba(139, 0, 0, 0.15);
            backdrop-filter: blur(15px);
            border: 2px solid rgba(139, 0, 0, 0.1);
        }

        .welcome-section h2 {
            font-size: 36px;
            margin-bottom: 15px;
            color: var(--primary);
            font-weight: 800;
        }

        .welcome-section p {
            color: #64748b;
            font-size: 20px;
            font-weight: 500;
        }

        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 30px;
            margin-bottom: 50px;
        }

        .folder-card {
            background-color: rgba(255, 255, 255, 0.98);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(139, 0, 0, 0.15);
            padding: 35px;
            text-align: center;
            cursor: pointer;
            transition: all 0.4s ease;
            backdrop-filter: blur(20px);
            border: 2px solid rgba(139, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }

        .folder-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(139, 0, 0, 0.1), transparent);
            transition: left 0.6s ease;
        }

        .folder-card:hover::before {
            left: 100%;
        }

        .folder-card:hover {
            transform: translateY(-12px) scale(1.05);
            box-shadow: 0 25px 50px rgba(139, 0, 0, 0.25);
            background-color: rgba(255, 255, 255, 1);
            border-color: var(--primary);
        }

        .folder-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 25px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 6px 20px rgba(0,0,0,0.25);
            transition: transform 0.3s ease;
            border: 2px solid rgba(139, 0, 0, 0.1);
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            color: white;
            overflow: hidden;
        }

        .folder-icon img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
        }

        .folder-card:hover .folder-icon {
            transform: scale(1.1) rotate(5deg);
        }

        .folder-card h3 {
            font-size: 22px;
            margin-bottom: 10px;
            color: var(--dark);
            font-weight: 700;
        }

        .folder-card p {
            font-size: 15px;
            color: #64748b;
            font-weight: 500;
        }

        /* DOCUMENT TYPES VIEW */
        .document-types {
            display: none;
        }

        .breadcrumb {
            display: flex;
            align-items: center;
            margin-bottom: 40px;
            font-size: 16px;
            background: rgba(255, 255, 255, 0.95);
            padding: 20px 25px;
            border-radius: 15px;
            backdrop-filter: blur(15px);
            box-shadow: 0 5px 20px rgba(139, 0, 0, 0.1);
        }

        .breadcrumb a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
            transition: color 0.3s ease;
        }

        .breadcrumb a:hover {
            color: var(--secondary);
            text-decoration: underline;
        }

        .breadcrumb .separator {
            margin: 0 18px;
            color: #94a3b8;
            font-weight: bold;
        }

        .breadcrumb .current {
            color: #64748b;
            font-weight: 700;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            background: rgba(255, 255, 255, 0.98);
            padding: 30px 35px;
            border-radius: 20px;
            backdrop-filter: blur(15px);
            box-shadow: 0 8px 25px rgba(139, 0, 0, 0.15);
        }

        .section-header h2 {
            font-size: 32px;
            color: var(--primary);
            font-weight: 800;
        }

        /* DOCUMENTS LIST VIEW */
        .documents-list {
            display: none;
        }

        .table-container {
            background-color: rgba(255, 255, 255, 0.98);
            border-radius: 20px;
            box-shadow: 0 15px 40px rgba(139, 0, 0, 0.15);
            overflow: hidden;
            margin-bottom: 40px;
            backdrop-filter: blur(20px);
            border: 2px solid rgba(139, 0, 0, 0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }

        th, td {
            padding: 20px 25px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        th {
            font-size: 16px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        td {
            font-size: 15px;
            color: var(--dark);
            font-weight: 500;
        }

        tr:hover {
            background-color: rgba(139, 0, 0, 0.05);
        }

        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .btn-sm {
            padding: 10px 18px;
            font-size: 14px;
            border-radius: 10px;
            font-weight: 600;
        }

        .btn-info {
            background: linear-gradient(135deg, #17a2b8, #20c997);
        }

        .btn-info:hover {
            background: linear-gradient(135deg, #138496, #1e7e34);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107, #fd7e14);
        }

        .btn-warning:hover {
            background: linear-gradient(135deg, #e0a800, #e55a00);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545, #c82333);
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #c82333, #a02622);
        }

        /* PERSON FORM */
        .person-form {
            display: none;
            background-color: rgba(255, 255, 255, 0.98);
            border-radius: 25px;
            box-shadow: 0 20px 50px rgba(139, 0, 0, 0.15);
            padding: 50px;
            margin-bottom: 40px;
            backdrop-filter: blur(20px);
            border: 2px solid rgba(139, 0, 0, 0.1);
            margin-top: 50px;
        }

        .form-row {
            display: flex;
            gap: 30px;
            margin-bottom: 30px;
        }

        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        .form-section {
            margin-bottom: 40px;
            padding: 30px;
            background: rgba(139, 0, 0, 0.02);
            border-radius: 15px;
            border: 2px solid rgba(139, 0, 0, 0.1);
        }

        .form-section h3 {
            color: var(--primary);
            font-size: 22px;
            margin-bottom: 25px;
            font-weight: 700;
            padding-bottom: 15px;
            border-bottom: 3px solid rgba(139, 0, 0, 0.1);
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 20px;
            margin-top: 50px;
            padding-top: 30px;
            border-top: 3px solid rgba(139, 0, 0, 0.1);
        }

        .file-upload {
            margin-top: 30px;
            border: 4px dashed rgba(139, 0, 0, 0.3);
            padding: 40px;
            text-align: center;
            border-radius: 20px;
            background: rgba(139, 0, 0, 0.02);
            transition: all 0.3s ease;
        }

        .file-upload:hover {
            border-color: var(--primary);
            background: rgba(139, 0, 0, 0.05);
        }

        .file-upload p {
            margin-bottom: 20px;
            color: var(--primary);
            font-weight: 600;
            font-size: 18px;
        }

        .file-list {
            margin-top: 30px;
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 18px 25px;
            background: rgba(139, 0, 0, 0.05);
            border-radius: 12px;
            margin-bottom: 12px;
            border: 1px solid rgba(139, 0, 0, 0.1);
        }

        .file-name {
            font-size: 15px;
            color: var(--dark);
            font-weight: 600;
        }

        .file-actions {
            display: flex;
            gap: 10px;
        }

        .file-preview {
            max-width: 300px;
            max-height: 200px;
            object-fit: cover;
            border-radius: 8px;
            margin-top: 10px;
        }

        /* SEARCH RESULTS */
        .search-results {
            display: none;
            margin: 25px 0;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 20px;
            box-shadow: 0 15px 40px rgba(139, 0, 0, 0.15);
            backdrop-filter: blur(20px);
            border: 2px solid rgba(139, 0, 0, 0.1);
        }

        .search-header {
            margin-bottom: 0;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 25px 35px;
            border-radius: 20px 20px 0 0;
        }

        .search-header h2 {
            font-size: 24px;
            margin-bottom: 8px;
            color: white;
            font-weight: 700;
        }

        .search-header p {
            color: rgba(255, 255, 255, 0.9);
            font-size: 16px;
            font-weight: 500;
            margin: 0;
        }

        .no-results {
            text-align: center;
            padding: 80px 0;
            color: #64748b;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 20px;
            backdrop-filter: blur(15px);
            font-size: 18px;
            font-weight: 600;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(139, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            backdrop-filter: blur(8px);
        }

        .modal {
            background-color: rgba(255, 255, 255, 0.98);
            border-radius: 25px;
            box-shadow: 0 25px 75px rgba(139, 0, 0, 0.4);
            width: 100%;
            max-width: 600px;
            padding: 50px;
            position: relative;
            backdrop-filter: blur(20px);
            border: 3px solid rgba(139, 0, 0, 0.1);
            animation: modalSlideIn 0.5s ease-out;
            max-height: 90vh;
            overflow-y: auto;
        }

        @keyframes modalSlideIn {
            from { transform: scale(0.8) translateY(50px); opacity: 0; }
            to { transform: scale(1) translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 35px;
            padding-bottom: 25px;
            border-bottom: 3px solid rgba(139, 0, 0, 0.1);
        }

        .modal-header h2 {
            font-size: 26px;
            color: var(--primary);
            font-weight: 800;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 35px;
            color: #94a3b8;
            cursor: pointer;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background-color: rgba(139, 0, 0, 0.1);
            color: var(--primary);
            transform: scale(1.1);
        }

        .modal-body {
            margin-bottom: 35px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 20px;
            padding-top: 25px;
            border-top: 3px solid rgba(139, 0, 0, 0.1);
        }

        /* Campos espec√≠ficos por tipo de documento */
        .document-fields {
            display: none;
        }

        .document-fields.active {
            display: block;
        }

        /* Lista para sele√ß√£o de itens para remover */
        .remove-list {
            max-height: 300px;
            overflow-y: auto;
            border: 2px solid rgba(139, 0, 0, 0.1);
            border-radius: 10px;
            padding: 15px;
        }

        .remove-item {
            display: flex;
            align-items: center;
            padding: 12px;
            margin-bottom: 8px;
            background: rgba(139, 0, 0, 0.05);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .remove-item:hover {
            background: rgba(139, 0, 0, 0.1);
        }

        .remove-item input[type="checkbox"] {
            margin-right: 12px;
            transform: scale(1.2);
        }

        .remove-item label {
            cursor: pointer;
            font-weight: 600;
            color: var(--dark);
            flex: 1;
        }

        /* Success message */
        .success-message {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--success);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            font-weight: 600;
            z-index: 9999;
            animation: slideInRight 0.3s ease-out;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* File View Modal Styles */
        .file-view-modal {
            max-width: 90vw;
            max-height: 95vh;
        }

        .file-view-content {
            max-height: 70vh;
            overflow: auto;
            text-align: center;
            padding: 20px 0;
        }

        .file-view-image {
            max-width: 100%;
            max-height: 65vh;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .file-view-iframe {
            width: 100%;
            height: 65vh;
            border: none;
            border-radius: 8px;
            background: #f8f9fa;
        }

        .file-view-text {
            text-align: left;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            max-height: 50vh;
            overflow-y: auto;
            border: 1px solid #dee2e6;
        }

        .file-view-text pre {
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 14px;
            margin: 0;
        }

        .file-view-error {
            padding: 40px;
            text-align: center;
            color: #64748b;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .file-view-error h3 {
            color: var(--primary);
            margin-bottom: 20px;
            font-size: 24px;
        }

        .file-view-error p {
            margin-bottom: 10px;
            font-size: 16px;
        }

        .file-view-error .file-info {
            background: rgba(139, 0, 0, 0.05);
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid var(--primary);
        }

        .retry-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            margin-top: 15px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .retry-btn:hover {
            background: #c82333;
            transform: translateY(-1px);
        }

        /* Document availability status */
        .file-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }

        .file-status.available {
            background: #d4edda;
            color: #155724;
        }

        .file-status.unavailable {
            background: #f8d7da;
            color: #721c24;
        }

        /* Loading state for file operations */
        .file-loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        /* Upload progress indicator */
        .upload-progress {
            background: rgba(139, 0, 0, 0.1);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            border-left: 4px solid var(--primary);
        }

        .upload-progress h4 {
            color: var(--primary);
            margin-bottom: 10px;
            font-size: 16px;
        }

        .upload-progress-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(139, 0, 0, 0.1);
        }

        .upload-progress-item:last-child {
            border-bottom: none;
        }

        .upload-status {
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }

        .upload-status.success {
            background: #d4edda;
            color: #155724;
        }

        .upload-status.error {
            background: #f8d7da;
            color: #721c24;
        }

        .upload-status.uploading {
            background: #fff3cd;
            color: #856404;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 25px;
            }

            .search-bar {
                max-width: 100%;
                margin: 25px 0;
            }

            .form-row {
                flex-direction: column;
                gap: 25px;
            }

            .table-container {
                overflow-x: auto;
            }

            .card-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                gap: 20px;
            }

            .folder-card {
                padding: 25px;
            }

            .folder-icon {
                width: 70px;
                height: 70px;
            }

            .folder-icon img {
                width: 50px;
                height: 50px;
            }

            .welcome-section {
                padding: 25px;
            }

            .welcome-section h2 {
                font-size: 28px;
            }

            .person-form, .modal {
                padding: 30px;
            }

            .section-header {
                flex-direction: column;
                gap: 20px;
                align-items: flex-start;
            }

            .section-actions {
                width: 100%;
                justify-content: center;
            }

            .file-view-modal {
                max-width: 95vw;
                padding: 20px;
            }

            .file-view-content {
                max-height: 60vh;
            }

            .file-view-iframe {
                height: 50vh;
            }

            .login-header .church-logo {
                width: 100px;
                height: 100px;
            }

            .logo .church-logo {
                width: 50px;
                height: 50px;
            }

            .user-menu .avatar {
                width: 40px;
                height: 40px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Spinner -->
    <div class="loading" id="loadingSpinner">
        <div class="spinner"></div>
    </div>

    <!-- Login Page -->
    <div class="login-container" id="loginPage">
        <div class="login-card">
            <div class="login-header">
                <div class="church-logo">
                    <img src="images/igreja1.jpg" alt="Igreja" />
                </div>
                <h1>Gerenciamento Paroquial</h1>
                <p>Sistema Profissional de Gest√£o</p>
            </div>
            <div id="loginError" class="alert alert-danger" style="display: none;">
                Email ou senha incorretos. Por favor, tente novamente.
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label for="email">E-mail ou nome de usu√°rio</label>
                    <input type="text" id="email" name="email" required>
                </div>
                <div class="form-group">
                    <label for="password">Senha</label>
                    <input type="password" id="password" name="password" required>
                </div>
                <button type="submit" class="btn btn-primary btn-block">Acessar Sistema</button>
            </form>
        </div>
    </div>

    <!-- Dashboard Page -->
    <div class="dashboard" id="dashboardPage">
        <header>
            <div class="container">
                <div class="header-content">
                    <div class="logo">
                        <div class="church-logo">
                            <img src="images/igreja1.jpg" alt="Igreja" />
                        </div>
                        <h1>Gerenciamento Paroquial</h1>
                    </div>
                    <div class="search-bar">
                        <input type="text" id="globalSearch" placeholder="Buscar por nome ou data de nascimento...">
                        <button type="button" class="search-btn" id="searchBtn">
                            <img src="https://img.icons8.com/fluency/24/search.png" alt="Buscar" />
                        </button>
                    </div>
                    <div class="user-menu">
                        <div class="avatar" id="userAvatar">
                            <img src="images/igreja1.jpg" alt="Usu√°rio" />
                        </div>
                        <span class="user-name" id="userName">Administrador</span>
                        <button class="logout-btn" id="logoutBtn">Sair</button>
                    </div>
                </div>
            </div>
        </header>

        <main class="container">
            <section class="welcome-section">
                <h2>Bem-vindo, <span id="welcomeUserName">Administrador</span>!</h2>
                <p>Sistema Profissional de Gerenciamento Paroquial - Organize todos os registros da comunidade</p>
            </section>

            <!-- Search Results Section -->
            <section class="search-results" id="searchResultsSection">
                <div class="search-header">
                    <h2>üìã Resultados da Busca</h2>
                    <p>Exibindo resultados para: <strong id="searchTerm"></strong> 
                        <button class="btn-red" id="clearSearchBtn" style="margin-left: 15px; padding: 5px 15px; font-size: 12px;">‚úï Limpar</button>
                    </p>
                </div>
                <div class="table-container" style="border-radius: 0 0 20px 20px;">
                    <table>
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Tipo de Documento</th>
                                <th>Data de Nascimento</th>
                                <th>Data do Registro</th>
                                <th>Ano</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="searchResultsTable">
                        </tbody>
                    </table>
                </div>
                <div class="no-results" id="noResults" style="display: none;">
                    <p>üîç Nenhum resultado encontrado para a sua busca.</p>
                    <p style="margin-top: 10px; font-size: 16px; color: #94a3b8;">
                        Dica: Tente pesquisar por nome completo, parte do nome, ou nome + data de nascimento<br>
                        Exemplo: "Maria Silva" ou "Maria Silva 15/06/1990"
                    </p>
                </div>
            </section>

            <section>
                <div class="section-header">
                    <h2>Arquivos por Ano</h2>
                    <div class="section-actions">
                        <button class="btn-red" id="addYearBtnHeader">Adicionar</button>
                        <button class="btn-red" id="removeYearBtnHeader">Remover</button>
                    </div>
                </div>
                <div class="card-grid" id="yearsGrid">
                    <!-- Years will be dynamically added here -->
                </div>
            </section>
        </main>
    </div>

    <!-- Document Types Page -->
    <div class="document-types" id="documentTypesPage">
        <header>
            <div class="container">
                <div class="header-content">
                    <div class="logo">
                        <div class="church-logo">
                            <img src="images/igreja1.jpg" alt="Igreja" />
                        </div>
                        <h1>Gerenciamento Paroquial</h1>
                    </div>
                    <div class="search-bar">
                        <input type="text" id="globalSearch2" placeholder="Buscar por nome ou data de nascimento...">
                        <button type="button" class="search-btn" id="searchBtn2">
                            <img src="https://img.icons8.com/fluency/24/search.png" alt="Buscar" />
                        </button>
                    </div>
                    <div class="user-menu">
                        <div class="avatar" id="userAvatar2">
                            <img src="images/igreja1.jpg" alt="Usu√°rio" />
                        </div>
                        <span class="user-name" id="userName2">Administrador</span>
                        <button class="logout-btn" id="logoutBtn2">Sair</button>
                    </div>
                </div>
            </div>
        </header>

        <main class="container">
            <div class="breadcrumb">
                <a href="#" id="backToDashboard">Dashboard</a>
                <span class="separator">‚Ä∫</span>
                <span class="current" id="yearTitle">2023</span>
            </div>

            <section>
                <div class="section-header">
                    <h2>Tipos de Documentos - <span id="yearHeaderTitle">2023</span></h2>
                    <div class="section-actions">
                        <button class="btn-red" id="addDocTypeBtnHeader">Adicionar</button>
                        <button class="btn-red" id="removeDocTypeBtnHeader">Remover</button>
                    </div>
                </div>
                <div class="card-grid" id="documentTypesGrid">
                    <!-- Document types will be dynamically added here -->
                </div>
            </section>
        </main>
    </div>

    <!-- Documents List Page -->
    <div class="documents-list" id="documentsListPage">
        <header>
            <div class="container">
                <div class="header-content">
                    <div class="logo">
                        <div class="church-logo">
                            <img src="images/igreja1.jpg" alt="Igreja" />
                        </div>
                        <h1>Gerenciamento Paroquial</h1>
                    </div>
                    <div class="search-bar">
                        <input type="text" id="globalSearch3" placeholder="Buscar por nome ou data de nascimento...">
                        <button type="button" class="search-btn" id="searchBtn3">
                            <img src="https://img.icons8.com/fluency/24/search.png" alt="Buscar" />
                        </button>
                    </div>
                    <div class="user-menu">
                        <div class="avatar" id="userAvatar3">
                            <img src="images/igreja1.jpg" alt="Usu√°rio" />
                        </div>
                        <span class="user-name" id="userName3">Administrador</span>
                        <button class="logout-btn" id="logoutBtn3">Sair</button>
                    </div>
                </div>
            </div>
        </header>

        <main class="container">
            <div class="breadcrumb">
                <a href="#" id="backToDashboard2">Dashboard</a>
                <span class="separator">‚Ä∫</span>
                <a href="#" id="backToDocTypes">2023</a>
                <span class="separator">‚Ä∫</span>
                <span class="current" id="docTypeTitle">Batismo</span>
            </div>

            <section>
                <div class="section-header">
                    <h2><span id="docTypeHeaderTitle">Batismo</span> - <span id="yearHeaderTitle2">2023</span></h2>
                    <button class="btn btn-primary" id="addPersonBtn">Adicionar Pessoa</button>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Data de Nascimento</th>
                                <th>Data do Registro</th>
                                <th>Arquivos</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="documentsTable">
                        </tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <!-- Person Form -->
    <div class="person-form" id="personFormContainer">
        <div class="container">
            <!-- Search Results Section - tamb√©m mostrar no form -->
            <section class="search-results" id="searchResultsFormSection" style="display: none;">
                <div class="search-header">
                    <h2>üìã Resultados da Busca</h2>
                    <p>Exibindo resultados para: <strong id="searchTermForm"></strong> 
                        <button class="btn-red" id="clearSearchFormBtn" style="margin-left: 15px; padding: 5px 15px; font-size: 12px;">‚úï Limpar</button>
                    </p>
                </div>
                <div class="table-container" style="border-radius: 0 0 20px 20px;">
                    <table>
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Tipo de Documento</th>
                                <th>Data de Nascimento</th>
                                <th>Data do Registro</th>
                                <th>Ano</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="searchResultsFormTable">
                        </tbody>
                    </table>
                </div>
                <div class="no-results" id="noResultsForm" style="display: none;">
                    <p>üîç Nenhum resultado encontrado para a sua busca.</p>
                    <p style="margin-top: 10px; font-size: 16px; color: #94a3b8;">
                        Dica: Tente pesquisar por nome completo, parte do nome, ou nome + data de nascimento<br>
                        Exemplo: "Maria Silva" ou "Maria Silva 15/06/1990"
                    </p>
                </div>
            </section>

            <div class="breadcrumb">
                <a href="#" id="backToDashboard3">Dashboard</a>
                <span class="separator">‚Ä∫</span>
                <a href="#" id="backToDocTypes2">2023</a>
                <span class="separator">‚Ä∫</span>
                <a href="#" id="backToDocList">Batismo</a>
                <span class="separator">‚Ä∫</span>
                <span class="current" id="formTitle">Novo Registro</span>
            </div>

            <div class="section-header">
                <h2 id="formHeaderTitle">Adicionar Registro de Batismo</h2>
            </div>

            <form id="personForm">
                <!-- Campos espec√≠ficos para Batismo -->
                <div class="document-fields active" id="batismoFields">
                    <div class="form-section">
                        <h3>Dados do Batismo</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="batismoFullName">Nome Completo *</label>
                                <input type="text" id="batismoFullName" name="batismoFullName">
                            </div>
                            <div class="form-group">
                                <label for="batismoBirthDate">Data de Nascimento *</label>
                                <input type="date" id="batismoBirthDate" name="batismoBirthDate">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="baptismDate">Data do Batismo</label>
                                <input type="date" id="baptismDate" name="baptismDate">
                            </div>
                            <div class="form-group">
                                <label for="baptismPlace">Local do Batismo</label>
                                <input type="text" id="baptismPlace" name="baptismPlace" placeholder="Ex: Par√≥quia S√£o Crist√≥v√£o">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="celebrant">Nome do Celebrante</label>
                                <input type="text" id="celebrant" name="celebrant" placeholder="Ex: Pe. Jo√£o Paulo">
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>Dados dos Pais</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="parentName1">Nome do Pai</label>
                                <input type="text" id="parentName1" name="parentName1">
                            </div>
                            <div class="form-group">
                                <label for="parentName2">Nome da M√£e</label>
                                <input type="text" id="parentName2" name="parentName2">
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>Padrinhos</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="godparent1">Nome do Padrinho</label>
                                <input type="text" id="godparent1" name="godparent1">
                            </div>
                            <div class="form-group">
                                <label for="godparent2">Nome da Madrinha</label>
                                <input type="text" id="godparent2" name="godparent2">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Campos espec√≠ficos para Crisma -->
                <div class="document-fields" id="crismaFields">
                    <div class="form-section">
                        <h3>Dados da Crisma</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="crismaFullName">Nome Completo *</label>
                                <input type="text" id="crismaFullName" name="crismaFullName">
                            </div>
                            <div class="form-group">
                                <label for="crismaBirthDate">Data de Nascimento *</label>
                                <input type="date" id="crismaBirthDate" name="crismaBirthDate">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="confirmationDate">Data da Crisma</label>
                                <input type="date" id="confirmationDate" name="confirmationDate">
                            </div>
                            <div class="form-group">
                                <label for="confirmationPlace">Local da Crisma</label>
                                <input type="text" id="confirmationPlace" name="confirmationPlace">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="bishop">Nome do Bispo/Celebrante</label>
                                <input type="text" id="bishop" name="bishop">
                            </div>
                            <div class="form-group">
                                <label for="confirmationGodparent">Padrinho/Madrinha de Crisma</label>
                                <input type="text" id="confirmationGodparent" name="confirmationGodparent">
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>Dados dos Pais</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="crismaParentName1">Nome do Pai</label>
                                <input type="text" id="crismaParentName1" name="crismaParentName1">
                            </div>
                            <div class="form-group">
                                <label for="crismaParentName2">Nome da M√£e</label>
                                <input type="text" id="crismaParentName2" name="crismaParentName2">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Campos espec√≠ficos para Primeira Comunh√£o -->
                <div class="document-fields" id="comunhaoFields">
                    <div class="form-section">
                        <h3>Dados da Primeira Comunh√£o</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="comunhaoFullName">Nome Completo *</label>
                                <input type="text" id="comunhaoFullName" name="comunhaoFullName">
                            </div>
                            <div class="form-group">
                                <label for="comunhaoBirthDate">Data de Nascimento *</label>
                                <input type="date" id="comunhaoBirthDate" name="comunhaoBirthDate">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="communionDate">Data da Primeira Comunh√£o</label>
                                <input type="date" id="communionDate" name="communionDate">
                            </div>
                            <div class="form-group">
                                <label for="communionPlace">Local da Celebra√ß√£o</label>
                                <input type="text" id="communionPlace" name="communionPlace">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="communionPriest">Nome do Sacerdote Respons√°vel</label>
                            <input type="text" id="communionPriest" name="communionPriest">
                        </div>
                    </div>
                </div>

                <!-- Campos espec√≠ficos para Casamento -->
                <div class="document-fields" id="casamentoFields">
                    <div class="form-section">
                        <h3>Dados do Casamento</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="marriageDate">Data do Casamento</label>
                                <input type="date" id="marriageDate" name="marriageDate">
                            </div>
                            <div class="form-group">
                                <label for="marriagePlace">Local do Casamento</label>
                                <input type="text" id="marriagePlace" name="marriagePlace">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="marriageCelebrant">Nome do Celebrante</label>
                            <input type="text" id="marriageCelebrant" name="marriageCelebrant">
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>Dados dos Noivos</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="groomName">Nome Completo do Noivo *</label>
                                <input type="text" id="groomName" name="groomName">
                            </div>
                            <div class="form-group">
                                <label for="groomBirthDate">Data de Nascimento do Noivo</label>
                                <input type="date" id="groomBirthDate" name="groomBirthDate">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="brideName">Nome Completo da Noiva *</label>
                                <input type="text" id="brideName" name="brideName">
                            </div>
                            <div class="form-group">
                                <label for="brideBirthDate">Data de Nascimento da Noiva</label>
                                <input type="date" id="brideBirthDate" name="brideBirthDate">
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>Dados dos Pais dos Noivos</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="groomFather">Nome do Pai do Noivo</label>
                                <input type="text" id="groomFather" name="groomFather">
                            </div>
                            <div class="form-group">
                                <label for="groomMother">Nome da M√£e do Noivo</label>
                                <input type="text" id="groomMother" name="groomMother">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="brideFather">Nome do Pai da Noiva</label>
                                <input type="text" id="brideFather" name="brideFather">
                            </div>
                            <div class="form-group">
                                <label for="brideMother">Nome da M√£e da Noiva</label>
                                <input type="text" id="brideMother" name="brideMother">
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>Testemunhas (Padrinhos)</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="witness1">1¬™ Testemunha</label>
                                <input type="text" id="witness1" name="witness1">
                            </div>
                            <div class="form-group">
                                <label for="witness2">2¬™ Testemunha</label>
                                <input type="text" id="witness2" name="witness2">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Campos espec√≠ficos para √ìbito -->
                <div class="document-fields" id="obitoFields">
                    <div class="form-section">
                        <h3>Dados do Falecimento</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="obitoFullName">Nome Completo *</label>
                                <input type="text" id="obitoFullName" name="obitoFullName">
                            </div>
                            <div class="form-group">
                                <label for="obituBirthDate">Data de Nascimento *</label>
                                <input type="date" id="obituBirthDate" name="obituBirthDate">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="deathDate">Data do Falecimento</label>
                                <input type="date" id="deathDate" name="deathDate">
                            </div>
                            <div class="form-group">
                                <label for="burialPlace">Local do Sepultamento</label>
                                <input type="text" id="burialPlace" name="burialPlace">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="ritesPerformed">Ritos Realizados</label>
                            <textarea id="ritesPerformed" name="ritesPerformed" placeholder="Ex: Missa de corpo presente, encomenda√ß√£o..."></textarea>
                        </div>
                    </div>
                </div>

                <!-- Campos espec√≠ficos para Admiss√£o de Membros -->
                <div class="document-fields" id="admissaoFields">
                    <div class="form-section">
                        <h3>Dados de Admiss√£o</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="admissaoFullName">Nome Completo *</label>
                                <input type="text" id="admissaoFullName" name="admissaoFullName">
                            </div>
                            <div class="form-group">
                                <label for="admissaoBirthDate">Data de Nascimento *</label>
                                <input type="date" id="admissaoBirthDate" name="admissaoBirthDate">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="admissionDate">Data de Ingresso</label>
                                <input type="date" id="admissionDate" name="admissionDate">
                            </div>
                            <div class="form-group">
                                <label for="address">Endere√ßo</label>
                                <input type="text" id="address" name="address">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="ministries">Minist√©rios ou Fun√ß√µes Exercidas</label>
                            <textarea id="ministries" name="ministries" placeholder="Ex: Ministro Extraordin√°rio da Eucaristia, Catequista..."></textarea>
                        </div>
                    </div>
                </div>

                <!-- Observa√ß√µes gerais -->
                <div class="form-section">
                    <h3>Observa√ß√µes Gerais</h3>
                    <div class="form-group">
                        <label for="observations">Observa√ß√µes</label>
                        <textarea id="observations" name="observations" placeholder="Informa√ß√µes adicionais relevantes..."></textarea>
                    </div>
                </div>

                <!-- Upload de arquivos -->
                <div class="file-upload" id="fileUploadArea">
                    <p>Arraste arquivos aqui ou clique para fazer upload</p>
                    <input type="file" id="fileUpload" name="fileUpload" multiple accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
                </div>

                <div class="file-list" id="fileList">
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-danger" id="cancelFormBtn">Cancelar</button>
                    <button type="submit" class="btn btn-primary" id="submitFormBtn">Salvar Registro</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modais -->
    <div class="modal-overlay" id="addYearModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Adicionar Novo Ano</h2>
                <button class="modal-close" id="closeYearModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="newYear">Ano</label>
                    <input type="number" id="newYear" name="newYear" min="1900" max="2100" required>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" id="cancelYearBtn">Cancelar</button>
                <button class="btn btn-primary" id="saveYearBtn">Adicionar</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="addDocTypeModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Adicionar Novo Tipo de Documento</h2>
                <button class="modal-close" id="closeDocTypeModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="newDocType">Nome do Tipo de Documento</label>
                    <input type="text" id="newDocType" name="newDocType" required>
                </div>
                <div class="form-group">
                    <label for="docTypeDescription">Descri√ß√£o</label>
                    <input type="text" id="docTypeDescription" name="docTypeDescription">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" id="cancelDocTypeBtn">Cancelar</button>
                <button class="btn btn-primary" id="saveDocTypeBtn">Adicionar</button>
            </div>
        </div>
    </div>

    <!-- Modal para remover anos -->
    <div class="modal-overlay" id="removeYearModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Remover Anos</h2>
                <button class="modal-close" id="closeRemoveYearModal">&times;</button>
            </div>
            <div class="modal-body">
                <p>Selecione os anos que deseja remover:</p>
                <div class="remove-list" id="removeYearList">
                    <!-- Anos para remo√ß√£o ser√£o listados aqui -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" id="cancelRemoveYearBtn">Cancelar</button>
                <button class="btn btn-primary" id="confirmRemoveYearBtn">Remover Selecionados</button>
            </div>
        </div>
    </div>

    <!-- Modal para remover tipos de documento -->
    <div class="modal-overlay" id="removeDocTypeModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Remover Tipos de Documento</h2>
                <button class="modal-close" id="closeRemoveDocTypeModal">&times;</button>
            </div>
            <div class="modal-body">
                <p>Selecione os tipos de documento que deseja remover:</p>
                <div class="remove-list" id="removeDocTypeList">
                    <!-- Tipos de documento para remo√ß√£o ser√£o listados aqui -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" id="cancelRemoveDocTypeBtn">Cancelar</button>
                <button class="btn btn-primary" id="confirmRemoveDocTypeBtn">Remover Selecionados</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="deleteConfirmModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Confirmar Exclus√£o</h2>
                <button class="modal-close" id="closeDeleteModal">&times;</button>
            </div>
            <div class="modal-body">
                <p>Tem certeza que deseja excluir este registro? Esta a√ß√£o n√£o pode ser desfeita.</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" id="cancelDeleteBtn">Cancelar</button>
                <button class="btn btn-danger" id="confirmDeleteBtn">Excluir</button>
            </div>
        </div>
    </div>

    <!-- Modal para visualizar arquivo -->
    <div class="modal-overlay" id="fileViewModal">
        <div class="modal file-view-modal">
            <div class="modal-header">
                <h2 id="fileViewTitle">Visualizar Arquivo</h2>
                <button class="modal-close" id="closeFileViewModal">&times;</button>
            </div>
            <div class="modal-body file-view-content" id="fileViewContent">
                <!-- Conte√∫do do arquivo ser√° exibido aqui -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" id="downloadFileBtn">Download</button>
                <button class="btn btn-danger" id="closeFileViewBtn">Fechar</button>
            </div>
        </div>
    </div>

    <script>
        // Initialize Supabase - SUAS CREDENCIAIS
        const SUPABASE_URL = 'https://objhnypjkrocgixsyejf.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9iamhueXBqa3JvY2dpeHN5ZWpmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA3NzU2MDIsImV4cCI6MjA2NjM1MTYwMn0.tOg52_qdTVwy5N09abTBxmKmFb4h0yJaSutPxKflZKY';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Global state
        let currentUser = null;
        let selectedYear = null;
        let selectedDocType = null;
        let selectedDocTypeId = null;
        let selectedDocument = null;
        let isEditMode = false;
        let currentPage = 'dashboard';
        let uploadedFiles = [];
        let selectedFileForView = null;
        let isSubmitting = false;

        // Cache for database data
        let yearsCache = [];
        let documentTypesCache = [];
        let documentsCache = [];

        // Mapa de √≠cones para tipos de documento
        const documentTypeIcons = {
            'batismo': 'images/batismo.png',
            'crisma': 'images/crisma.png',
            'comunhao': 'images/comunhao.png',
            'casamento': 'images/casamento.png',
            'obito': 'images/obito.png',
            'admissao': 'images/membros.png',
            'default': 'images/outros.png'
        };

        // DOM Elements
        const loginPage = document.getElementById('loginPage');
        const dashboardPage = document.getElementById('dashboardPage');
        const documentTypesPage = document.getElementById('documentTypesPage');
        const documentsListPage = document.getElementById('documentsListPage');
        const personFormContainer = document.getElementById('personFormContainer');
        const searchResultsSection = document.getElementById('searchResultsSection');
        const searchResultsFormSection = document.getElementById('searchResultsFormSection');
        const loadingSpinner = document.getElementById('loadingSpinner');

        // Utility functions
        function showLoading() {
            loadingSpinner.style.display = 'flex';
        }

        function hideLoading() {
            loadingSpinner.style.display = 'none';
        }

        function showError(message) {
            const errorDiv = document.getElementById('loginError');
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
                setTimeout(() => {
                    errorDiv.style.display = 'none';
                }, 5000);
            } else {
                alert(message);
            }
            console.error('Error:', message);
        }

        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success-message';
            successDiv.textContent = message;
            document.body.appendChild(successDiv);
            
            setTimeout(() => {
                if (successDiv.parentNode) {
                    successDiv.parentNode.removeChild(successDiv);
                }
            }, 3000);
        }

        // FUN√á√ïES DE VALIDA√á√ÉO E OBTEN√á√ÉO DE DADOS DOS CAMPOS
        function getFieldValue(fieldId) {
            const field = document.getElementById(fieldId);
            return field ? field.value.trim() : '';
        }

        function setFieldValue(fieldId, value) {
            const field = document.getElementById(fieldId);
            if (field) {
                field.value = value || '';
            }
        }

        function validateDocumentData() {
            console.log('=== VALIDA√á√ÉO INICIADA ===');
            console.log('selectedDocTypeId:', selectedDocTypeId);
            console.log('selectedDocType:', selectedDocType);

            // Verificar se h√° tipo de documento selecionado
            if (!selectedDocTypeId || !selectedDocType) {
                console.error('Nenhum tipo de documento selecionado');
                return { valid: false, missing: ['Tipo de documento n√£o selecionado'] };
            }

            const docType = documentTypesCache.find(t => t.id === selectedDocTypeId);
            if (!docType) {
                console.error('Tipo de documento n√£o encontrado no cache');
                return { valid: false, missing: ['Tipo de documento inv√°lido'] };
            }

            console.log('Validando para tipo:', docType.slug);

            // Identificar qual se√ß√£o de campos est√° ativa
            const activeFields = document.querySelector('.document-fields.active');
            if (!activeFields) {
                console.error('Nenhuma se√ß√£o de campos ativa');
                return { valid: false, missing: ['Nenhuma se√ß√£o de campos ativa'] };
            }

            const fieldId = activeFields.id;
            console.log('Se√ß√£o ativa:', fieldId);

            let requiredFields = [];
            let fieldsToCheck = [];

            // Definir campos obrigat√≥rios baseado na se√ß√£o ativa
            switch (fieldId) {
                case 'batismoFields':
                    requiredFields = ['batismoFullName', 'batismoBirthDate'];
                    fieldsToCheck = ['batismoFullName', 'batismoBirthDate'];
                    break;
                case 'crismaFields':
                    requiredFields = ['crismaFullName', 'crismaBirthDate'];
                    fieldsToCheck = ['crismaFullName', 'crismaBirthDate'];
                    break;
                case 'comunhaoFields':
                    requiredFields = ['comunhaoFullName', 'comunhaoBirthDate'];
                    fieldsToCheck = ['comunhaoFullName', 'comunhaoBirthDate'];
                    break;
                case 'casamentoFields':
                    requiredFields = ['groomName', 'brideName'];
                    fieldsToCheck = ['groomName', 'brideName'];
                    break;
                case 'obitoFields':
                    requiredFields = ['obitoFullName', 'obituBirthDate'];
                    fieldsToCheck = ['obitoFullName', 'obituBirthDate'];
                    break;
                case 'admissaoFields':
                    requiredFields = ['admissaoFullName', 'admissaoBirthDate'];
                    fieldsToCheck = ['admissaoFullName', 'admissaoBirthDate'];
                    break;
                default:
                    console.warn('Se√ß√£o de campos n√£o reconhecida:', fieldId);
                    return { valid: false, missing: ['Se√ß√£o de campos n√£o reconhecida'] };
            }

            console.log('Campos obrigat√≥rios:', requiredFields);

            let missingFields = [];
            fieldsToCheck.forEach(fieldName => {
                const value = getFieldValue(fieldName);
                console.log(`Campo ${fieldName}:`, value);
                if (!value && requiredFields.includes(fieldName)) {
                    missingFields.push(fieldName);
                }
            });

            console.log('Campos faltando:', missingFields);
            console.log('=== VALIDA√á√ÉO FINALIZADA ===');

            return {
                valid: missingFields.length === 0,
                missing: missingFields,
                activeSection: fieldId
            };
        }

        function getDocumentData() {
            console.log('=== PREPARANDO DADOS DO DOCUMENTO ===');
            
            if (!selectedDocTypeId) {
                throw new Error('Nenhum tipo de documento selecionado');
            }

            const docType = documentTypesCache.find(t => t.id === selectedDocTypeId);
            if (!docType) {
                throw new Error('Tipo de documento n√£o encontrado');
            }

            // Identificar qual se√ß√£o de campos est√° ativa
            const activeFields = document.querySelector('.document-fields.active');
            if (!activeFields) {
                throw new Error('Nenhuma se√ß√£o de campos ativa');
            }

            const documentData = {
                year: parseInt(selectedYear),
                type_id: selectedDocTypeId,
                observations: getFieldValue('observations') || null
            };

            console.log('Preparando dados para se√ß√£o:', activeFields.id);

            const fieldId = activeFields.id;
            
            // Definir dados baseado na se√ß√£o ativa
            switch (fieldId) {
                case 'batismoFields':
                    documentData.name = getFieldValue('batismoFullName');
                    documentData.birth_date = getFieldValue('batismoBirthDate');
                    documentData.parent_name_1 = getFieldValue('parentName1') || null;
                    documentData.parent_name_2 = getFieldValue('parentName2') || null;
                    documentData.baptism_date = getFieldValue('baptismDate') || null;
                    documentData.celebrant = getFieldValue('celebrant') || null;
                    documentData.godparent_1 = getFieldValue('godparent1') || null;
                    documentData.godparent_2 = getFieldValue('godparent2') || null;
                    documentData.baptism_place = getFieldValue('baptismPlace') || null;
                    break;

                case 'crismaFields':
                    documentData.name = getFieldValue('crismaFullName');
                    documentData.birth_date = getFieldValue('crismaBirthDate');
                    documentData.confirmation_date = getFieldValue('confirmationDate') || null;
                    documentData.confirmation_place = getFieldValue('confirmationPlace') || null;
                    documentData.bishop = getFieldValue('bishop') || null;
                    documentData.confirmation_godparent = getFieldValue('confirmationGodparent') || null;
                    documentData.crisma_parent_name_1 = getFieldValue('crismaParentName1') || null;
                    documentData.crisma_parent_name_2 = getFieldValue('crismaParentName2') || null;
                    break;

                case 'comunhaoFields':
                    documentData.name = getFieldValue('comunhaoFullName');
                    documentData.birth_date = getFieldValue('comunhaoBirthDate');
                    documentData.communion_date = getFieldValue('communionDate') || null;
                    documentData.communion_place = getFieldValue('communionPlace') || null;
                    documentData.communion_priest = getFieldValue('communionPriest') || null;
                    break;

                case 'casamentoFields':
                    const groomName = getFieldValue('groomName');
                    const brideName = getFieldValue('brideName');
                    documentData.name = `${groomName} & ${brideName}`;
                    documentData.birth_date = getFieldValue('groomBirthDate') || getFieldValue('brideBirthDate') || null;
                    documentData.marriage_date = getFieldValue('marriageDate') || null;
                    documentData.marriage_place = getFieldValue('marriagePlace') || null;
                    documentData.marriage_celebrant = getFieldValue('marriageCelebrant') || null;
                    documentData.groom_name = groomName || null;
                    documentData.groom_birth_date = getFieldValue('groomBirthDate') || null;
                    documentData.bride_name = brideName || null;
                    documentData.bride_birth_date = getFieldValue('brideBirthDate') || null;
                    documentData.groom_father = getFieldValue('groomFather') || null;
                    documentData.groom_mother = getFieldValue('groomMother') || null;
                    documentData.bride_father = getFieldValue('brideFather') || null;
                    documentData.bride_mother = getFieldValue('brideMother') || null;
                    documentData.witness_1 = getFieldValue('witness1') || null;
                    documentData.witness_2 = getFieldValue('witness2') || null;
                    break;

                case 'obitoFields':
                    documentData.name = getFieldValue('obitoFullName');
                    documentData.birth_date = getFieldValue('obituBirthDate');
                    documentData.death_date = getFieldValue('deathDate') || null;
                    documentData.burial_place = getFieldValue('burialPlace') || null;
                    documentData.rites_performed = getFieldValue('ritesPerformed') || null;
                    break;

                case 'admissaoFields':
                    documentData.name = getFieldValue('admissaoFullName');
                    documentData.birth_date = getFieldValue('admissaoBirthDate');
                    documentData.admission_date = getFieldValue('admissionDate') || null;
                    documentData.address = getFieldValue('address') || null;
                    documentData.ministries = getFieldValue('ministries') || null;
                    break;

                default:
                    throw new Error('Se√ß√£o de campos n√£o reconhecida: ' + fieldId);
            }

            // Validar se os campos principais foram preenchidos
            if (!documentData.name || !documentData.name.trim()) {
                throw new Error('Nome √© obrigat√≥rio');
            }

            // Adicionar data de registro apenas para novos documentos
            if (!isEditMode || !selectedDocument) {
                documentData.registration_date = new Date().toISOString().split('T')[0];
            }

            console.log('Dados do documento preparados:', documentData);
            console.log('=== PREPARA√á√ÉO DE DADOS FINALIZADA ===');
            return documentData;
        }

        function populateForm(doc) {
            const docType = documentTypesCache.find(t => t.id === doc.type_id);
            if (!docType) return;

            console.log('Preenchendo formul√°rio para tipo:', docType.slug);
            showDocumentFields(docType.slug);

            // Preencher observa√ß√µes
            setFieldValue('observations', doc.observations);

            const docSlug = docType.slug.toLowerCase();

            // Identificar tipo baseado no slug ou nos dados dispon√≠veis
            if (docSlug.includes('batismo') || docSlug === 'batismo' || doc.baptism_date || doc.godparent_1) {
                setFieldValue('batismoFullName', doc.name);
                setFieldValue('batismoBirthDate', doc.birth_date);
                setFieldValue('parentName1', doc.parent_name_1);
                setFieldValue('parentName2', doc.parent_name_2);
                setFieldValue('baptismDate', doc.baptism_date);
                setFieldValue('celebrant', doc.celebrant);
                setFieldValue('godparent1', doc.godparent_1);
                setFieldValue('godparent2', doc.godparent_2);
                setFieldValue('baptismPlace', doc.baptism_place);
            } else if (docSlug.includes('crisma') || docSlug === 'crisma' || doc.confirmation_date || doc.bishop) {
                setFieldValue('crismaFullName', doc.name);
                setFieldValue('crismaBirthDate', doc.birth_date);
                setFieldValue('confirmationDate', doc.confirmation_date);
                setFieldValue('confirmationPlace', doc.confirmation_place);
                setFieldValue('bishop', doc.bishop);
                setFieldValue('confirmationGodparent', doc.confirmation_godparent);
                setFieldValue('crismaParentName1', doc.crisma_parent_name_1);
                setFieldValue('crismaParentName2', doc.crisma_parent_name_2);
            } else if (docSlug.includes('comunhao') || docSlug === 'comunhao' || docSlug.includes('primeira-comunhao') || doc.communion_date) {
                setFieldValue('comunhaoFullName', doc.name);
                setFieldValue('comunhaoBirthDate', doc.birth_date);
                setFieldValue('communionDate', doc.communion_date);
                setFieldValue('communionPlace', doc.communion_place);
                setFieldValue('communionPriest', doc.communion_priest);
            } else if (docSlug.includes('casamento') || docSlug === 'casamento' || doc.marriage_date || doc.groom_name || doc.bride_name) {
                setFieldValue('groomName', doc.groom_name);
                setFieldValue('groomBirthDate', doc.groom_birth_date);
                setFieldValue('brideName', doc.bride_name);
                setFieldValue('brideBirthDate', doc.bride_birth_date);
                setFieldValue('marriageDate', doc.marriage_date);
                setFieldValue('marriagePlace', doc.marriage_place);
                setFieldValue('marriageCelebrant', doc.marriage_celebrant);
                setFieldValue('groomFather', doc.groom_father);
                setFieldValue('groomMother', doc.groom_mother);
                setFieldValue('brideFather', doc.bride_father);
                setFieldValue('brideMother', doc.bride_mother);
                setFieldValue('witness1', doc.witness_1);
                setFieldValue('witness2', doc.witness_2);
            } else if (docSlug.includes('obito') || docSlug === 'obito' || docSlug.includes('√≥bito') || doc.death_date) {
                setFieldValue('obitoFullName', doc.name);
                setFieldValue('obituBirthDate', doc.birth_date);
                setFieldValue('deathDate', doc.death_date);
                setFieldValue('burialPlace', doc.burial_place);
                setFieldValue('ritesPerformed', doc.rites_performed);
            } else if (docSlug.includes('admissao') || docSlug === 'admissao' || docSlug.includes('admiss√£o') || doc.admission_date) {
                setFieldValue('admissaoFullName', doc.name);
                setFieldValue('admissaoBirthDate', doc.birth_date);
                setFieldValue('admissionDate', doc.admission_date);
                setFieldValue('address', doc.address);
                setFieldValue('ministries', doc.ministries);
            } else {
                // Fallback - usar batismo como padr√£o
                console.log('Usando fallback para batismo');
                setFieldValue('batismoFullName', doc.name);
                setFieldValue('batismoBirthDate', doc.birth_date);
                showDocumentFields('batismo');
            }
        }

        // FUN√á√ïES DE BANCO DE DADOS
        async function loadYears() {
            try {
                if (yearsCache.length > 0) {
                    return yearsCache;
                }
                
                console.log('Carregando anos...');
                const { data, error } = await supabase
                    .from('years')
                    .select('*')
                    .order('year', { ascending: false });
                
                if (error) {
                    console.error('Erro ao carregar anos:', error);
                    throw error;
                }
                
                console.log('Anos carregados:', data);
                yearsCache = data || [];
                return yearsCache;
            } catch (error) {
                console.error('Error loading years:', error);
                showError('Erro ao carregar anos: ' + error.message);
                return [];
            }
        }

        async function loadDocumentTypes() {
            try {
                if (documentTypesCache.length > 0) {
                    return documentTypesCache;
                }
                
                console.log('Carregando tipos de documento...');
                const { data, error } = await supabase
                    .from('document_types')
                    .select('*')
                    .order('name');
                
                if (error) {
                    console.error('Erro ao carregar tipos:', error);
                    throw error;
                }
                
                console.log('Tipos carregados:', data);
                documentTypesCache = data || [];
                return documentTypesCache;
            } catch (error) {
                console.error('Error loading document types:', error);
                showError('Erro ao carregar tipos de documento: ' + error.message);
                return [];
            }
        }

        async function loadDocuments(year, typeId) {
            try {
                showLoading();
                console.log('Carregando documentos para ano:', year, 'tipo:', typeId);
                
                const { data, error } = await supabase
                    .from('documents')
                    .select(`
                        *,
                        document_types(name),
                        files(*)
                    `)
                    .eq('year', year)
                    .eq('type_id', typeId)
                    .order('name');
                
                if (error) {
                    console.error('Erro ao carregar documentos:', error);
                    throw error;
                }
                
                console.log('Documentos carregados:', data);
                hideLoading();
                return data || [];
            } catch (error) {
                console.error('Error loading documents:', error);
                hideLoading();
                showError('Erro ao carregar documentos: ' + error.message);
                return [];
            }
        }

        async function searchDocuments(searchTerm) {
            try {
                showLoading();
                console.log('Buscando por:', searchTerm);
                
                const dateRegex = /(\d{1,2}\/\d{1,2}\/\d{4}|\d{4}-\d{1,2}-\d{1,2})/;
                const hasDate = dateRegex.test(searchTerm);
                
                let query = supabase
                    .from('documents')
                    .select(`
                        *,
                        document_types(name),
                        files(*)
                    `);
                
                if (hasDate) {
                    const parts = searchTerm.split(/\s+/);
                    const datePart = parts.find(part => dateRegex.test(part));
                    const nameParts = parts.filter(part => !dateRegex.test(part));
                    const nameTerm = nameParts.join(' ');
                    
                    let isoDate = datePart;
                    if (datePart.includes('/')) {
                        const [day, month, year] = datePart.split('/');
                        isoDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                    }
                    
                    if (nameTerm.trim()) {
                        query = query
                            .ilike('name', `%${nameTerm.trim()}%`)
                            .eq('birth_date', isoDate);
                    } else {
                        query = query.eq('birth_date', isoDate);
                    }
                } else {
                    query = query.ilike('name', `%${searchTerm}%`);
                }
                
                const { data, error } = await query.order('name').limit(50);
                
                if (error) {
                    console.error('Erro na busca:', error);
                    throw error;
                }
                
                console.log('Resultados da busca:', data);
                hideLoading();
                return data || [];
            } catch (error) {
                console.error('Error searching documents:', error);
                hideLoading();
                showError('Erro ao buscar documentos: ' + error.message);
                return [];
            }
        }

        async function saveDocument(documentData) {
            try {
                showLoading();
                console.log('Salvando documento:', documentData);
                
                let savedDoc;
                
                if (isEditMode && selectedDocument) {
                    console.log('Atualizando documento ID:', selectedDocument);
                    const { data, error } = await supabase
                        .from('documents')
                        .update(documentData)
                        .eq('id', selectedDocument)
                        .select()
                        .single();
                    
                    if (error) {
                        console.error('Erro ao atualizar:', error);
                        throw error;
                    }
                    savedDoc = data;
                } else {
                    console.log('Criando novo documento');
                    const { data, error } = await supabase
                        .from('documents')
                        .insert([documentData])
                        .select()
                        .single();
                    
                    if (error) {
                        console.error('Erro ao inserir:', error);
                        throw error;
                    }
                    savedDoc = data;
                }
                
                console.log('Documento salvo:', savedDoc);
                
                // Fazer upload de arquivos se houver
                if (uploadedFiles.length > 0) {
                    console.log('Fazendo upload de arquivos...');
                    await saveDocumentFiles(savedDoc.id, uploadedFiles);
                }
                
                hideLoading();
                return savedDoc;
            } catch (error) {
                console.error('Error saving document:', error);
                hideLoading();
                throw error;
            }
        }

        async function saveDocumentFiles(documentId, files) {
            try {
                console.log('Salvando arquivos para documento:', documentId);
                const savedFiles = [];
                let uploadErrors = [];
                
                const batchSize = 3;
                for (let i = 0; i < files.length; i += batchSize) {
                    const batch = files.slice(i, i + batchSize);
                    
                    const batchPromises = batch.map(async (fileData) => {
                        try {
                            console.log('Processando arquivo:', fileData.name);
                            
                            if (!fileData.file || fileData.file.size === 0) {
                                throw new Error('Arquivo inv√°lido ou vazio');
                            }
                            
                            if (fileData.file.size > 10 * 1024 * 1024) {
                                throw new Error('Arquivo muito grande (m√°ximo 10MB)');
                            }
                            
                            const fileDataUrl = await new Promise((resolve, reject) => {
                                const reader = new FileReader();
                                reader.onload = (e) => resolve(e.target.result);
                                reader.onerror = (e) => reject(new Error('Erro ao ler arquivo'));
                                reader.readAsDataURL(fileData.file);
                            });
                            
                            console.log('Arquivo convertido para base64. Tamanho:', fileDataUrl.length);
                            
                            const { data: dbData, error: dbError } = await supabase
                                .from('files')
                                .insert([{
                                    document_id: documentId,
                                    name: fileData.name,
                                    file_type: fileData.file.type || 'application/octet-stream',
                                    file_data: fileDataUrl
                                }])
                                .select()
                                .single();
                            
                            if (dbError) {
                                console.error('Erro no banco:', dbError);
                                throw new Error(`Erro no banco de dados: ${dbError.message}`);
                            }
                            
                            savedFiles.push(dbData);
                            console.log('Arquivo salvo com sucesso:', fileData.name);
                            return dbData;
                            
                        } catch (fileError) {
                            console.error('Erro ao processar arquivo:', fileData.name, fileError);
                            uploadErrors.push(`${fileData.name}: ${fileError.message}`);
                            return null;
                        }
                    });
                    
                    await Promise.all(batchPromises);
                }
                
                const successCount = savedFiles.length;
                const errorCount = uploadErrors.length;
                
                if (successCount > 0) {
                    showSuccess(`${successCount} arquivo(s) carregado(s) com sucesso!`);
                }
                
                if (errorCount > 0) {
                    showError(`${errorCount} arquivo(s) falharam no upload: ${uploadErrors.join(', ')}`);
                }
                
                return savedFiles;
                
            } catch (error) {
                console.error('Erro geral no upload:', error);
                showError('Erro geral ao processar arquivos: ' + error.message);
                throw error;
            }
        }

        async function loadDocumentForEdit(docId) {
            try {
                showLoading();
                console.log('Carregando documento para edi√ß√£o:', docId);
                
                const { data: doc, error } = await supabase
                    .from('documents')
                    .select(`
                        *,
                        document_types(name),
                        files(*)
                    `)
                    .eq('id', docId)
                    .single();
                
                hideLoading();
                
                if (error) {
                    console.error('Erro ao carregar documento:', error);
                    throw error;
                }
                
                console.log('Documento carregado:', doc);
                return doc;
                
            } catch (error) {
                hideLoading();
                console.error('Error loading document:', error);
                showError('Erro ao carregar documento: ' + error.message);
                return null;
            }
        }

        // FUN√á√ÉO PARA VISUALIZAR ARQUIVO
        async function viewSavedFile(fileId) {
            try {
                showLoading();
                console.log('Carregando arquivo ID:', fileId);
                
                const { data: fileData, error } = await supabase
                    .from('files')
                    .select('*')
                    .eq('id', fileId)
                    .single();
                
                hideLoading();
                
                if (error) {
                    console.error('Error loading file:', error);
                    showError('Erro ao carregar dados do arquivo: ' + error.message);
                    return;
                }
                
                if (!fileData) {
                    showError('Arquivo n√£o encontrado');
                    return;
                }
                
                selectedFileForView = {
                    id: fileData.id,
                    name: fileData.name,
                    type: fileData.file_type,
                    data: fileData.file_data,
                    blobUrl: fileData.file_data
                };
                
                showFileViewModal();
                
            } catch (error) {
                hideLoading();
                console.error('Error viewing file:', error);
                showError('Erro ao visualizar arquivo: ' + error.message);
            }
        }

        function showFileViewModal() {
            const modal = document.getElementById('fileViewModal');
            const title = document.getElementById('fileViewTitle');
            const content = document.getElementById('fileViewContent');
            
            if (!selectedFileForView) {
                showError('Nenhum arquivo selecionado');
                return;
            }
            
            title.textContent = `Visualizar: ${selectedFileForView.name}`;
            content.innerHTML = '';
            
            if (!selectedFileForView.data) {
                content.innerHTML = `
                    <div class="file-view-error">
                        <h3>‚ö†Ô∏è Arquivo N√£o Dispon√≠vel</h3>
                        <p style="margin: 20px 0; color: #dc3545;">
                            O arquivo n√£o foi carregado corretamente no sistema.
                        </p>
                    </div>
                `;
                modal.style.display = 'flex';
                return;
            }
            
            try {
                if (selectedFileForView.type && selectedFileForView.type.startsWith('image/')) {
                    const img = document.createElement('img');
                    img.src = selectedFileForView.data;
                    img.className = 'file-view-image';
                    img.alt = selectedFileForView.name;
                    content.appendChild(img);
                    
                } else if (selectedFileForView.type === 'application/pdf') {
                    const iframe = document.createElement('iframe');
                    iframe.src = selectedFileForView.data;
                    iframe.className = 'file-view-iframe';
                    content.appendChild(iframe);
                    
                } else {
                    content.innerHTML = `
                        <div class="file-view-error">
                            <h3>üìÑ ${selectedFileForView.name}</h3>
                            <p style="margin: 20px 0;">
                                Este tipo de arquivo n√£o pode ser visualizado no navegador.
                            </p>
                            <p style="color: #6c757d;">
                                Use o bot√£o "Download" para baixar e abrir o arquivo.
                            </p>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Erro ao processar arquivo:', error);
                content.innerHTML = `
                    <div class="file-view-error">
                        <h3>‚ùå Erro</h3>
                        <p style="margin: 20px 0; color: #dc3545;">Erro ao processar dados do arquivo: ${error.message}</p>
                    </div>
                `;
            }
            
            modal.style.display = 'flex';
        }

        async function downloadSavedFile(fileId) {
            try {
                showLoading();
                console.log('Fazendo download do arquivo ID:', fileId);
                
                const { data: fileData, error } = await supabase
                    .from('files')
                    .select('*')
                    .eq('id', fileId)
                    .single();
                
                hideLoading();
                
                if (error) {
                    console.error('Error loading file for download:', error);
                    showError('Erro ao carregar arquivo para download: ' + error.message);
                    return;
                }
                
                if (!fileData.file_data) {
                    showError('Arquivo n√£o est√° dispon√≠vel para download');
                    return;
                }
                
                try {
                    console.log('Criando download para:', fileData.name);
                    
                    const link = document.createElement('a');
                    link.href = fileData.file_data;
                    link.download = fileData.name;
                    
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    showSuccess('Download iniciado!');
                } catch (downloadError) {
                    console.error('Download error:', downloadError);
                    showError('Erro ao iniciar download: ' + downloadError.message);
                }
                
            } catch (error) {
                hideLoading();
                console.error('Error downloading file:', error);
                showError('Erro ao fazer download: ' + error.message);
            }
        }

        async function removeSavedFile(fileId) {
            if (!confirm('Tem certeza que deseja remover este arquivo? Esta a√ß√£o n√£o pode ser desfeita.')) {
                return;
            }
            
            try {
                showLoading();
                console.log('Removendo arquivo ID:', fileId);
                
                const { error: dbError } = await supabase
                    .from('files')
                    .delete()
                    .eq('id', fileId);
                
                hideLoading();
                
                if (dbError) {
                    console.error('Erro ao remover:', dbError);
                    showError('Erro ao remover registro do arquivo: ' + dbError.message);
                    return;
                }
                
                showSuccess('Arquivo removido com sucesso!');
                
                if (selectedDocument) {
                    loadDocumentForEdit(selectedDocument);
                }
                
            } catch (error) {
                hideLoading();
                console.error('Error removing file:', error);
                showError('Erro ao remover arquivo: ' + error.message);
            }
        }

        // Outras fun√ß√µes de banco de dados
        async function deleteDocument(documentId) {
            try {
                showLoading();
                console.log('Deletando documento ID:', documentId);
                
                const { error } = await supabase
                    .from('documents')
                    .delete()
                    .eq('id', documentId);
                
                if (error) {
                    console.error('Erro ao deletar:', error);
                    throw error;
                }
                
                hideLoading();
                return true;
            } catch (error) {
                console.error('Error deleting document:', error);
                hideLoading();
                showError('Erro ao excluir documento: ' + error.message);
                return false;
            }
        }

        async function addYear(year) {
            try {
                showLoading();
                console.log('Adicionando ano:', year);
                
                const { data, error } = await supabase
                    .from('years')
                    .insert([{ year: year }])
                    .select()
                    .single();
                
                if (error) {
                    console.error('Erro ao adicionar ano:', error);
                    throw error;
                }
                
                console.log('Ano adicionado:', data);
                yearsCache = [];
                hideLoading();
                return data;
            } catch (error) {
                console.error('Error adding year:', error);
                hideLoading();
                showError('Erro ao adicionar ano: ' + error.message);
                throw error;
            }
        }

        async function removeYears(years) {
            try {
                showLoading();
                console.log('Removendo anos:', years);
                
                const { error } = await supabase
                    .from('years')
                    .delete()
                    .in('year', years);
                
                if (error) {
                    console.error('Erro ao remover anos:', error);
                    throw error;
                }
                
                yearsCache = [];
                hideLoading();
                return true;
            } catch (error) {
                console.error('Error removing years:', error);
                hideLoading();
                showError('Erro ao remover anos: ' + error.message);
                return false;
            }
        }

        async function addDocumentType(docTypeData) {
            try {
                showLoading();
                console.log('Adicionando tipo de documento:', docTypeData);
                
                const { data, error } = await supabase
                    .from('document_types')
                    .insert([docTypeData])
                    .select()
                    .single();
                
                if (error) {
                    console.error('Erro ao adicionar tipo:', error);
                    throw error;
                }
                
                console.log('Tipo adicionado:', data);
                documentTypesCache = [];
                hideLoading();
                return data;
            } catch (error) {
                console.error('Error adding document type:', error);
                hideLoading();
                showError('Erro ao adicionar tipo de documento: ' + error.message);
                throw error;
            }
        }

        async function removeDocumentTypes(typeIds) {
            try {
                showLoading();
                console.log('Removendo tipos:', typeIds);
                
                const { error } = await supabase
                    .from('document_types')
                    .delete()
                    .in('id', typeIds);
                
                if (error) {
                    console.error('Erro ao remover tipos:', error);
                    throw error;
                }
                
                documentTypesCache = [];
                hideLoading();
                return true;
            } catch (error) {
                console.error('Error removing document types:', error);
                hideLoading();
                showError('Erro ao remover tipos de documento: ' + error.message);
                return false;
            }
        }

        // Initialize years grid
        async function initializeYearsGrid() {
            console.log('Inicializando grid de anos...');
            const yearsGrid = document.getElementById('yearsGrid');
            yearsGrid.innerHTML = '';
            
            const years = await loadYears();
            
            if (years.length === 0) {
                yearsGrid.innerHTML = '<p style="text-align: center; color: #6c757d; grid-column: 1/-1;">Nenhum ano cadastrado. Use o bot√£o "Adicionar" para criar o primeiro ano.</p>';
                return;
            }
            
            const fragment = document.createDocumentFragment();
            
            years.forEach(year => {
                const card = document.createElement('div');
                card.className = 'folder-card';
                card.setAttribute('data-year', year.year);
                card.innerHTML = `
                    <div class="folder-icon">
                        <img src="images/ano.png" alt="Calend√°rio" />
                    </div>
                    <h3>${year.year}</h3>
                    <p>Registros do ano</p>
                `;
                fragment.appendChild(card);
            });
            
            yearsGrid.appendChild(fragment);
        }

        // Initialize document types grid
        async function initializeDocumentTypesGrid() {
            console.log('Inicializando grid de tipos de documento...');
            const docTypesGrid = document.getElementById('documentTypesGrid');
            docTypesGrid.innerHTML = '';
            
            const docTypes = await loadDocumentTypes();
            
            if (docTypes.length === 0) {
                docTypesGrid.innerHTML = '<p style="text-align: center; color: #6c757d; grid-column: 1/-1;">Nenhum tipo de documento cadastrado. Use o bot√£o "Adicionar" para criar o primeiro tipo.</p>';
                return;
            }
            
            const fragment = document.createDocumentFragment();
            
            docTypes.forEach(docType => {
                const iconUrl = documentTypeIcons[docType.slug] || documentTypeIcons.default;
                const card = document.createElement('div');
                card.className = 'folder-card';
                card.setAttribute('data-type', docType.slug);
                card.setAttribute('data-type-id', docType.id);
                card.innerHTML = `
                    <div class="folder-icon">
                        <img src="${iconUrl}" alt="${docType.name}" />
                    </div>
                    <h3>${docType.name}</h3>
                    <p>${docType.description}</p>
                `;
                fragment.appendChild(card);
            });
            
            docTypesGrid.appendChild(fragment);
        }

        // Fun√ß√£o para mostrar campos espec√≠ficos do tipo de documento - CORRIGIDA
        function showDocumentFields(docType) {
            console.log('Mostrando campos para tipo:', docType);
            
            // Primeiro remove a classe active de todas as se√ß√µes e gerencia required
            document.querySelectorAll('.document-fields').forEach(field => {
                field.classList.remove('active');
                // Remove required de todos os campos da se√ß√£o que ser√° escondida
                field.querySelectorAll('input[required], textarea[required]').forEach(input => {
                    input.removeAttribute('required');
                    input.setAttribute('data-was-required', 'true');
                });
            });
            
            const docSlug = docType.toLowerCase();
            let fieldsToShow = null;
            
            if (docSlug.includes('batismo') || docSlug === 'batismo') {
                fieldsToShow = document.getElementById('batismoFields');
            } else if (docSlug.includes('crisma') || docSlug === 'crisma') {
                fieldsToShow = document.getElementById('crismaFields');
            } else if (docSlug.includes('comunhao') || docSlug === 'comunhao' || docSlug.includes('primeira-comunhao')) {
                fieldsToShow = document.getElementById('comunhaoFields');
            } else if (docSlug.includes('casamento') || docSlug === 'casamento') {
                fieldsToShow = document.getElementById('casamentoFields');
            } else if (docSlug.includes('obito') || docSlug === 'obito' || docSlug.includes('√≥bito')) {
                fieldsToShow = document.getElementById('obitoFields');
            } else if (docSlug.includes('admissao') || docSlug === 'admissao' || docSlug.includes('admiss√£o')) {
                fieldsToShow = document.getElementById('admissaoFields');
            } else {
                // Para tipos personalizados, usar batismo como padr√£o
                fieldsToShow = document.getElementById('batismoFields');
                console.log('Usando batismo como fallback para tipo personalizado:', docType);
            }
            
            if (fieldsToShow) {
                fieldsToShow.classList.add('active');
                // Reativa required apenas nos campos da se√ß√£o ativa que tinham required antes
                fieldsToShow.querySelectorAll('input[data-was-required], textarea[data-was-required]').forEach(input => {
                    input.setAttribute('required', 'required');
                });
                console.log('Campos ativados para:', docType, '- Se√ß√£o:', fieldsToShow.id);
            } else {
                console.error('Campos n√£o encontrados para tipo:', docType);
                // Como fallback, ativar batismo
                const batismoFields = document.getElementById('batismoFields');
                if (batismoFields) {
                    batismoFields.classList.add('active');
                    batismoFields.querySelectorAll('input[data-was-required], textarea[data-was-required]').forEach(input => {
                        input.setAttribute('required', 'required');
                    });
                    console.log('Fallback: ativado batismoFields');
                }
            }
        }

        // FUNCTIONS PARA MANIPULAR ARQUIVOS
        function viewUploadedFile(file) {
            try {
                selectedFileForView = {
                    name: file.name,
                    type: file.type,
                    data: file.dataUrl,
                    blobUrl: file.dataUrl
                };
                
                showFileViewModal();
            } catch (error) {
                console.error('Erro ao visualizar arquivo:', error);
                showError('Erro ao visualizar arquivo: ' + error.message);
            }
        }

        function downloadFile(file) {
            try {
                if (file.blobUrl || file.data) {
                    const link = document.createElement('a');
                    link.href = file.blobUrl || file.data;
                    link.download = file.name;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    showSuccess('Download iniciado!');
                } else if (file.id) {
                    downloadSavedFile(file.id);
                } else {
                    showError('Arquivo n√£o dispon√≠vel para download');
                }
            } catch (error) {
                console.error('Error downloading file:', error);
                showError('Erro ao fazer download do arquivo: ' + error.message);
            }
        }

        function refreshUploadedFilesList() {
            const fileList = document.getElementById('fileList');
            const existingFiles = fileList.querySelectorAll('.file-item[data-uploaded="true"]');
            
            existingFiles.forEach(item => item.remove());
            
            const fragment = document.createDocumentFragment();
            
            uploadedFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.setAttribute('data-uploaded', 'true');
                fileItem.innerHTML = `
                    <span class="file-name">${file.name} (${Math.round(file.file.size / 1024)} KB)</span>
                    <div class="file-actions">
                        <button type="button" class="btn btn-sm btn-info view-uploaded-file" data-index="${index}">Visualizar</button>
                        <button type="button" class="btn btn-sm btn-danger remove-file" data-index="${index}">Remover</button>
                    </div>
                `;
                fragment.appendChild(fileItem);
            });
            
            fileList.appendChild(fragment);
        }

        // LOGIN FUNCTIONALITY
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value.trim();
            
            if (!email || !password) {
                showError('Por favor, preencha todos os campos');
                return;
            }
            
            try {
                showLoading();
                console.log('Tentando login com:', email);
                
                const { data, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('email', email)
                    .eq('password', password)
                    .single();
                
                hideLoading();
                
                if (error || !data) {
                    console.error('Erro de login:', error);
                    showError('Email ou senha incorretos.');
                    return;
                }
                
                console.log('Login bem-sucedido:', data);
                currentUser = data;
                document.getElementById('loginError').style.display = 'none';
                
                ['userName', 'userName2', 'userName3', 'welcomeUserName'].forEach(id => {
                    const element = document.getElementById(id);
                    if (element) element.textContent = data.name;
                });
                
                loginPage.style.display = 'none';
                dashboardPage.style.display = 'block';
                dashboardPage.classList.add('active');
                
                await Promise.all([
                    initializeYearsGrid(),
                    initializeDocumentTypesGrid()
                ]);
                
            } catch (error) {
                hideLoading();
                console.error('Login error:', error);
                showError('Erro ao fazer login: ' + error.message);
            }
        });

        // LOGOUT FUNCTIONALITY
        const logoutButtons = document.querySelectorAll('#logoutBtn, #logoutBtn2, #logoutBtn3');
        logoutButtons.forEach(button => {
            button.addEventListener('click', function() {
                currentUser = null;
                yearsCache = [];
                documentTypesCache = [];
                documentsCache = [];
                
                loginPage.style.display = 'flex';
                dashboardPage.style.display = 'none';
                documentTypesPage.style.display = 'none';
                documentsListPage.style.display = 'none';
                personFormContainer.style.display = 'none';
                searchResultsSection.style.display = 'none';
                searchResultsFormSection.style.display = 'none';
                document.getElementById('loginForm').reset();
            });
        });

        // YEAR SELECTION
        document.getElementById('yearsGrid').addEventListener('click', function(e) {
            const card = e.target.closest('.folder-card');
            if (card) {
                selectedYear = card.getAttribute('data-year');
                console.log('Ano selecionado:', selectedYear);
                document.getElementById('yearTitle').textContent = selectedYear;
                document.getElementById('yearHeaderTitle').textContent = selectedYear;
                
                dashboardPage.style.display = 'none';
                searchResultsSection.style.display = 'none';
                documentTypesPage.style.display = 'block';
            }
        });

        // DOCUMENT TYPE SELECTION - CORRIGIDO
        document.getElementById('documentTypesGrid').addEventListener('click', async function(e) {
            const card = e.target.closest('.folder-card');
            if (card) {
                const typeSlug = card.getAttribute('data-type');
                const typeId = parseInt(card.getAttribute('data-type-id'));
                const docType = documentTypesCache.find(t => t.id === typeId);
                
                if (docType) {
                    selectedDocType = docType.name;
                    selectedDocTypeId = docType.id;
                    console.log('Tipo de documento selecionado:', selectedDocType, 'ID:', selectedDocTypeId);
                    
                    document.getElementById('docTypeTitle').textContent = selectedDocType;
                    document.getElementById('docTypeHeaderTitle').textContent = selectedDocType;
                    document.getElementById('yearHeaderTitle2').textContent = selectedYear;
                    
                    document.getElementById('backToDocTypes').textContent = selectedYear;
                    
                    await loadDocumentsTable(selectedYear, selectedDocTypeId);
                    
                    documentTypesPage.style.display = 'none';
                    documentsListPage.style.display = 'block';
                }
            }
        });

        // LOAD DOCUMENTS TABLE
        async function loadDocumentsTable(year, typeId) {
            console.log('Carregando tabela de documentos...');
            const docs = await loadDocuments(year, typeId);
            const tableBody = document.getElementById('documentsTable');
            tableBody.innerHTML = '';
            
            if (docs.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="5" style="text-align: center; color: #6c757d;">Nenhum documento cadastrado para este tipo e ano.</td>';
                tableBody.appendChild(row);
                return;
            }
            
            const fragment = document.createDocumentFragment();
            
            docs.forEach(doc => {
                const row = document.createElement('tr');
                row.setAttribute('data-id', doc.id);
                
                const birthDate = new Date(doc.birth_date).toLocaleDateString('pt-BR');
                const regDate = new Date(doc.registration_date).toLocaleDateString('pt-BR');
                const filesCount = doc.files ? doc.files.length : 0;
                const filesText = filesCount > 0 ? 
                    `${filesCount} ${filesCount === 1 ? 'arquivo' : 'arquivos'}` :
                    'Nenhum arquivo';
                
                row.innerHTML = `
                    <td>${doc.name}</td>
                    <td>${birthDate}</td>
                    <td>${regDate}</td>
                    <td>${filesText}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-info view-btn">Ver</button>
                            <button class="btn btn-sm btn-warning edit-btn">Editar</button>
                            <button class="btn btn-sm btn-danger delete-btn">Excluir</button>
                        </div>
                    </td>
                `;
                fragment.appendChild(row);
            });
            
            tableBody.appendChild(fragment);
        }

        // ADD NEW PERSON - CORRIGIDO
        function addNewPerson() {
            console.log('=== ADICIONANDO NOVA PESSOA ===');
            console.log('Selected Doc Type ID:', selectedDocTypeId);
            console.log('Selected Doc Type:', selectedDocType);
            console.log('Selected Year:', selectedYear);
            
            // Verificar se temos um tipo de documento selecionado
            if (!selectedDocTypeId || !selectedDocType) {
                showError('Erro: Tipo de documento n√£o identificado. Tente navegar novamente pela interface.');
                return;
            }
            
            // Verificar se temos um ano selecionado
            if (!selectedYear) {
                showError('Erro: Ano n√£o identificado. Tente navegar novamente pela interface.');
                return;
            }
            
            isEditMode = false;
            selectedDocument = null;
            uploadedFiles = [];
            isSubmitting = false;
            
            document.getElementById('personForm').reset();
            document.getElementById('fileList').innerHTML = '';
            
            document.getElementById('formTitle').textContent = 'Novo Registro';
            document.getElementById('formHeaderTitle').textContent = `Adicionar Registro de ${selectedDocType}`;
            
            document.getElementById('backToDocTypes2').textContent = selectedYear;
            document.getElementById('backToDocList').textContent = selectedDocType;
            
            const docType = documentTypesCache.find(t => t.id === selectedDocTypeId);
            if (docType) {
                console.log('Mostrando campos para tipo:', docType.slug);
                showDocumentFields(docType.slug);
            } else {
                console.error('Tipo de documento n√£o encontrado no cache');
                showError('Erro: Tipo de documento n√£o encontrado no cache');
                return;
            }
            
            const formInputs = document.querySelectorAll('#personForm input, #personForm textarea');
            formInputs.forEach(input => {
                input.readOnly = false;
            });
            
            const submitBtn = document.getElementById('submitFormBtn');
            submitBtn.disabled = false;
            submitBtn.textContent = 'Salvar Registro';
            submitBtn.style.display = 'inline-block';
            
            documentsListPage.style.display = 'none';
            searchResultsFormSection.style.display = 'none';
            personFormContainer.style.display = 'block';
            
            console.log('=== FORMUL√ÅRIO PRONTO PARA USO ===');
        }

        document.getElementById('addPersonBtn').addEventListener('click', addNewPerson);

        // PERSON FORM SUBMIT - COM DEBUG AVAN√áADO
        document.getElementById('personForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            console.log('=== FORMUL√ÅRIO ENVIADO ===');
            console.log('Event triggered successfully');
            
            // Debug: verificar estado atual
            console.log('Estado atual:');
            console.log('- isSubmitting:', isSubmitting);
            console.log('- selectedYear:', selectedYear);
            console.log('- selectedDocType:', selectedDocType);
            console.log('- selectedDocTypeId:', selectedDocTypeId);
            console.log('- isEditMode:', isEditMode);
            
            if (isSubmitting) {
                console.log('J√° est√° enviando, ignorando...');
                showError('J√° estamos processando. Aguarde...');
                return;
            }
            
            const submitBtn = document.getElementById('submitFormBtn');
            
            // Verifica√ß√£o de seguran√ßa
            if (!submitBtn) {
                console.error('Bot√£o de submit n√£o encontrado!');
                showError('Erro interno: bot√£o n√£o encontrado');
                return;
            }
            
            try {
                console.log('Iniciando valida√ß√£o...');
                
                // Debug: verificar se temos os dados necess√°rios
                if (!selectedDocTypeId) {
                    console.error('ERRO: selectedDocTypeId n√£o definido');
                    showError('Erro: Tipo de documento n√£o selecionado. Navegue pela interface novamente.');
                    return;
                }
                
                if (!selectedYear) {
                    console.error('ERRO: selectedYear n√£o definido');
                    showError('Erro: Ano n√£o selecionado. Navegue pela interface novamente.');
                    return;
                }
                
                // Validar dados
                const validation = validateDocumentData();
                console.log('Resultado da valida√ß√£o:', validation);
                
                if (!validation.valid) {
                    console.log('Valida√ß√£o falhou:', validation.missing);
                    showError(`Campos obrigat√≥rios n√£o preenchidos: ${validation.missing.join(', ')}`);
                    return;
                }
                
                console.log('Valida√ß√£o passou! Iniciando submiss√£o...');
                
                // Indicar que estamos processando
                isSubmitting = true;
                submitBtn.disabled = true;
                submitBtn.textContent = 'Salvando...';
                submitBtn.style.opacity = '0.7';
                
                console.log('Preparando dados do documento...');
                
                let documentData;
                try {
                    documentData = getDocumentData();
                    console.log('Dados preparados com sucesso:', documentData);
                } catch (dataError) {
                    console.error('Erro ao preparar dados:', dataError);
                    throw new Error('Erro ao preparar dados: ' + dataError.message);
                }
                
                // Verificar conex√£o antes de salvar
                console.log('Verificando conex√£o com Supabase...');
                try {
                    const { data: testConnection, error: connectionError } = await supabase
                        .from('users')
                        .select('id')
                        .limit(1);
                    
                    if (connectionError) {
                        console.error('Erro de conex√£o:', connectionError);
                        throw new Error('Erro de conex√£o com o banco de dados');
                    }
                    console.log('Conex√£o OK');
                } catch (connError) {
                    console.error('Falha na conex√£o:', connError);
                    throw new Error('N√£o foi poss√≠vel conectar ao banco de dados');
                }
                
                console.log('Salvando documento...');
                showLoading();
                
                const savedDoc = await saveDocument(documentData);
                
                hideLoading();
                console.log('Documento salvo com sucesso:', savedDoc);
                
                const action = isEditMode ? 'atualizado' : 'criado';
                showSuccess(`Documento ${action} com sucesso!`);
                
                // Limpar estado
                uploadedFiles = [];
                isEditMode = false;
                selectedDocument = null;
                
                // Aguardar um pouco antes de recarregar
                setTimeout(async () => {
                    try {
                        // Recarregar lista de documentos
                        await loadDocumentsTable(selectedYear, selectedDocTypeId);
                        
                        // Voltar para lista
                        personFormContainer.style.display = 'none';
                        searchResultsFormSection.style.display = 'none';
                        documentsListPage.style.display = 'block';
                        
                        // Limpar formul√°rio
                        document.getElementById('personForm').reset();
                        document.getElementById('fileList').innerHTML = '';
                        
                        console.log('Processo conclu√≠do com sucesso!');
                    } catch (reloadError) {
                        console.error('Erro ao recarregar lista:', reloadError);
                        showError('Documento salvo, mas houve erro ao recarregar a lista');
                    }
                }, 500);
                
            } catch (error) {
                hideLoading();
                console.error('ERRO DURANTE SALVAMENTO:', error);
                console.error('Stack trace:', error.stack);
                
                let errorMessage = 'Erro desconhecido ao salvar documento';
                if (error.message) {
                    errorMessage = error.message;
                } else if (error.error && error.error.message) {
                    errorMessage = error.error.message;
                }
                
                showError('Erro ao salvar: ' + errorMessage);
            } finally {
                isSubmitting = false;
                submitBtn.disabled = false;
                submitBtn.style.opacity = '1';
                submitBtn.textContent = isEditMode ? 'Salvar Altera√ß√µes' : 'Salvar Registro';
                hideLoading();
                console.log('=== PROCESSO FINALIZADO ===');
            }
        });

        // DOCUMENT ACTIONS (VIEW, EDIT, DELETE)
        document.getElementById('documentsTable').addEventListener('click', async function(e) {
            if (e.target.classList.contains('view-btn') || e.target.classList.contains('edit-btn')) {
                const row = e.target.closest('tr');
                const docId = parseInt(row.getAttribute('data-id'));
                
                console.log('A√ß√£o em documento ID:', docId);
                
                const doc = await loadDocumentForEdit(docId);
                if (!doc) return;
                
                uploadedFiles = [];
                isSubmitting = false;
                
                selectedDocument = docId;
                isEditMode = e.target.classList.contains('edit-btn');
                
                console.log('Modo edi√ß√£o:', isEditMode);
                
                populateForm(doc);
                
                const fileList = document.getElementById('fileList');
                fileList.innerHTML = '';
                
                if (doc.files && doc.files.length > 0) {
                    doc.files.forEach(file => {
                        const fileItem = document.createElement('div');
                        fileItem.className = 'file-item';
                        
                        fileItem.innerHTML = `
                            <span class="file-name">
                                ${file.name}
                            </span>
                            <div class="file-actions">
                                <button type="button" class="btn btn-sm btn-info view-file-btn" data-file-id="${file.id}">Visualizar</button>
                                <button type="button" class="btn btn-sm btn-primary download-file-btn" data-file-id="${file.id}">Download</button>
                                ${isEditMode ? `<button type="button" class="btn btn-sm btn-danger remove-file-btn" data-file-id="${file.id}">Remover</button>` : ''}
                            </div>
                        `;
                        fileList.appendChild(fileItem);
                    });
                }
                
                document.getElementById('formTitle').textContent = isEditMode ? 'Editar Registro' : 'Visualizar Registro';
                document.getElementById('formHeaderTitle').textContent = `${isEditMode ? 'Editar' : 'Visualizar'} Registro de ${doc.document_types.name}`;
                
                const formInputs = document.querySelectorAll('#personForm input, #personForm textarea');
                formInputs.forEach(input => {
                    input.readOnly = !isEditMode;
                });
                
                const submitBtn = document.getElementById('submitFormBtn');
                if (isEditMode) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Salvar Altera√ß√µes';
                    submitBtn.style.display = 'inline-block';
                } else {
                    // Esconder o bot√£o salvar no modo visualiza√ß√£o
                    submitBtn.style.display = 'none';
                }
                
                document.getElementById('backToDocTypes2').textContent = doc.year;
                document.getElementById('backToDocList').textContent = doc.document_types.name;
                
                documentsListPage.style.display = 'none';
                searchResultsFormSection.style.display = 'none';
                personFormContainer.style.display = 'block';
                
            } else if (e.target.classList.contains('delete-btn')) {
                const row = e.target.closest('tr');
                const docId = parseInt(row.getAttribute('data-id'));
                selectedDocument = docId;
                
                document.getElementById('deleteConfirmModal').style.display = 'flex';
            }
        });

        // HEADER BUTTON ACTIONS
        document.getElementById('addYearBtnHeader').addEventListener('click', function() {
            document.getElementById('newYear').value = new Date().getFullYear();
            document.getElementById('addYearModal').style.display = 'flex';
        });

        document.getElementById('addDocTypeBtnHeader').addEventListener('click', function() {
            document.getElementById('addDocTypeModal').style.display = 'flex';
        });

        document.getElementById('removeYearBtnHeader').addEventListener('click', function() {
            showRemoveYearModal();
        });

        document.getElementById('removeDocTypeBtnHeader').addEventListener('click', function() {
            showRemoveDocTypeModal();
        });

        function showRemoveYearModal() {
            const removeList = document.getElementById('removeYearList');
            removeList.innerHTML = '';
            
            yearsCache.forEach(year => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'remove-item';
                itemDiv.innerHTML = `
                    <input type="checkbox" id="year_${year.year}" value="${year.year}">
                    <label for="year_${year.year}">${year.year}</label>
                `;
                removeList.appendChild(itemDiv);
            });
            
            document.getElementById('removeYearModal').style.display = 'flex';
        }

        function showRemoveDocTypeModal() {
            const removeList = document.getElementById('removeDocTypeList');
            removeList.innerHTML = '';
            
            documentTypesCache.forEach(docType => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'remove-item';
                itemDiv.innerHTML = `
                    <input type="checkbox" id="doctype_${docType.id}" value="${docType.id}">
                    <label for="doctype_${docType.id}">${docType.name}</label>
                `;
                removeList.appendChild(itemDiv);
            });
            
            document.getElementById('removeDocTypeModal').style.display = 'flex';
        }

        document.getElementById('confirmRemoveYearBtn').addEventListener('click', async function() {
            const checkedYears = document.querySelectorAll('#removeYearList input[type="checkbox"]:checked');
            const yearsToRemove = Array.from(checkedYears).map(cb => parseInt(cb.value));
            
            if (yearsToRemove.length > 0) {
                const success = await removeYears(yearsToRemove);
                if (success) {
                    await initializeYearsGrid();
                    document.getElementById('removeYearModal').style.display = 'none';
                }
            }
        });

        document.getElementById('confirmRemoveDocTypeBtn').addEventListener('click', async function() {
            const checkedDocTypes = document.querySelectorAll('#removeDocTypeList input[type="checkbox"]:checked');
            const docTypesToRemove = Array.from(checkedDocTypes).map(cb => parseInt(cb.value));
            
            if (docTypesToRemove.length > 0) {
                const success = await removeDocumentTypes(docTypesToRemove);
                if (success) {
                    await initializeDocumentTypesGrid();
                    document.getElementById('removeDocTypeModal').style.display = 'none';
                }
            }
        });

        // CANCEL FORM BUTTON
        document.getElementById('cancelFormBtn').addEventListener('click', function() {
            uploadedFiles = [];
            isEditMode = false;
            selectedDocument = null;
            isSubmitting = false;
            
            document.getElementById('personForm').reset();
            document.getElementById('fileList').innerHTML = '';
            
            const submitBtn = document.getElementById('submitFormBtn');
            submitBtn.disabled = false;
            submitBtn.textContent = 'Salvar Registro';
            
            personFormContainer.style.display = 'none';
            searchResultsFormSection.style.display = 'none';
            documentsListPage.style.display = 'block';
        });

        // BREADCRUMB NAVIGATION
        document.getElementById('backToDashboard').addEventListener('click', function(e) {
            e.preventDefault();
            documentTypesPage.style.display = 'none';
            searchResultsSection.style.display = 'none';
            dashboardPage.style.display = 'block';
        });

        document.getElementById('backToDashboard2').addEventListener('click', function(e) {
            e.preventDefault();
            documentsListPage.style.display = 'none';
            searchResultsSection.style.display = 'none';
            dashboardPage.style.display = 'block';
        });

        document.getElementById('backToDashboard3').addEventListener('click', function(e) {
            e.preventDefault();
            personFormContainer.style.display = 'none';
            searchResultsSection.style.display = 'none';
            searchResultsFormSection.style.display = 'none';
            dashboardPage.style.display = 'block';
        });

        document.getElementById('backToDocTypes').addEventListener('click', function(e) {
            e.preventDefault();
            documentsListPage.style.display = 'none';
            documentTypesPage.style.display = 'block';
        });

        document.getElementById('backToDocTypes2').addEventListener('click', function(e) {
            e.preventDefault();
            personFormContainer.style.display = 'none';
            searchResultsFormSection.style.display = 'none';
            documentTypesPage.style.display = 'block';
        });

        document.getElementById('backToDocList').addEventListener('click', function(e) {
            e.preventDefault();
            personFormContainer.style.display = 'none';
            searchResultsFormSection.style.display = 'none';
            documentsListPage.style.display = 'block';
        });

        // GLOBAL SEARCH
const searchInputs = document.querySelectorAll('#globalSearch, #globalSearch2, #globalSearch3');
const searchButtons = document.querySelectorAll('#searchBtn, #searchBtn2, #searchBtn3');

let searchTimeout;

function handleSearch(input, inForm = false) {
    const searchTerm = input.value.trim();
    
    if (searchTimeout) {
        clearTimeout(searchTimeout);
    }
    
    // S√≥ fazer busca se tiver pelo menos 2 caracteres
    if (searchTerm.length >= 2) {
        searchTimeout = setTimeout(() => {
            performSearch(searchTerm, inForm);
        }, 500); // Aumentei o timeout para 500ms
    }
    // Removido a mensagem de erro que estava aparecendo desnecessariamente
}

searchInputs.forEach(input => {
    input.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            const searchTerm = this.value.trim();
            if (searchTerm.length >= 2) {
                if (searchTimeout) clearTimeout(searchTimeout);
                performSearch(searchTerm);
            } else {
                showError('Por favor, digite pelo menos 2 caracteres para buscar.');
            }
        }
    });
    
    input.addEventListener('input', function() {
        handleSearch(this);
    });
});

searchButtons.forEach((button, index) => {
    button.addEventListener('click', function() {
        const input = searchInputs[index];
        if (input) {
            const searchTerm = input.value.trim();
            if (searchTerm.length >= 2) {
                if (searchTimeout) clearTimeout(searchTimeout);
                performSearch(searchTerm);
            } else {
                showError('Por favor, digite pelo menos 2 caracteres para buscar.');
            }
        }
    });
});

async function performSearch(term, inForm = false) {
    console.log('Executando busca por:', term);
    const results = await searchDocuments(term);
    
    const searchTermElement = document.getElementById(inForm ? 'searchTermForm' : 'searchTerm');
    const resultsTable = document.getElementById(inForm ? 'searchResultsFormTable' : 'searchResultsTable');
    const noResultsElement = document.getElementById(inForm ? 'noResultsForm' : 'noResults');
    const searchSection = inForm ? searchResultsFormSection : searchResultsSection;
    
    searchTermElement.textContent = term;
    resultsTable.innerHTML = '';
    
    if (results.length > 0) {
        const fragment = document.createDocumentFragment();
        
        results.forEach(doc => {
            const row = document.createElement('tr');
            row.setAttribute('data-id', doc.id);
            row.setAttribute('data-year', doc.year);
            row.setAttribute('data-type-id', doc.type_id);
            
            const birthDate = new Date(doc.birth_date).toLocaleDateString('pt-BR');
            const regDate = new Date(doc.registration_date).toLocaleDateString('pt-BR');
            
            row.innerHTML = `
                <td>${doc.name}</td>
                <td>${doc.document_types.name}</td>
                <td>${birthDate}</td>
                <td>${regDate}</td>
                <td>${doc.year}</td>
                <td>
                    <div class="action-buttons">
                        <button class="btn btn-sm btn-info search-view-btn">Ver</button>
                    </div>
                </td>
            `;
            fragment.appendChild(row);
        });
        
        resultsTable.appendChild(fragment);
        noResultsElement.style.display = 'none';
    } else {
        noResultsElement.style.display = 'block';
    }
    
    searchSection.style.display = 'block';
    // Removido: searchInputs.forEach(input => input.value = ''); 
    // Isso estava limpando os campos automaticamente
}

        function handleSearchViewBtn(e) {
            if (e.target.classList.contains('search-view-btn')) {
                const row = e.target.closest('tr');
                const docId = parseInt(row.getAttribute('data-id'));
                const year = row.getAttribute('data-year');
                const typeId = parseInt(row.getAttribute('data-type-id'));
                
                console.log('Visualizando da busca - Doc:', docId, 'Year:', year, 'Type:', typeId);
                
                selectedYear = year;
                selectedDocTypeId = typeId;
                const docType = documentTypesCache.find(t => t.id === typeId);
                selectedDocType = docType ? docType.name : 'Documento';
                
                loadAndShowDocument(docId);
            }
        }

        async function loadAndShowDocument(docId) {
            const doc = await loadDocumentForEdit(docId);
            if (!doc) return;
            
            uploadedFiles = [];
            isSubmitting = false;
            
            selectedDocument = docId;
            isEditMode = false;
            
            populateForm(doc);
            
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '';
            
            if (doc.files && doc.files.length > 0) {
                doc.files.forEach(file => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    
                    fileItem.innerHTML = `
                        <span class="file-name">
                            ${file.name}
                        </span>
                        <div class="file-actions">
                            <button type="button" class="btn btn-sm btn-info view-file-btn" data-file-id="${file.id}">Visualizar</button>
                            <button type="button" class="btn btn-sm btn-primary download-file-btn" data-file-id="${file.id}">Download</button>
                        </div>
                    `;
                    fileList.appendChild(fileItem);
                });
            }
            
            document.getElementById('formTitle').textContent = 'Visualizar Registro';
            document.getElementById('formHeaderTitle').textContent = `Visualizar Registro de ${doc.document_types.name}`;
            
            const formInputs = document.querySelectorAll('#personForm input, #personForm textarea');
            formInputs.forEach(input => {
                input.readOnly = true;
            });
            
            const submitBtn = document.getElementById('submitFormBtn');
            // Esconder o bot√£o salvar no modo visualiza√ß√£o
            submitBtn.style.display = 'none';
            
            document.getElementById('backToDocTypes2').textContent = doc.year;
            document.getElementById('backToDocList').textContent = doc.document_types.name;
            
            const searchTermDashboard = document.getElementById('searchTerm').textContent;
            if (searchTermDashboard) {
                document.getElementById('searchTermForm').textContent = searchTermDashboard;
                const dashboardTable = document.getElementById('searchResultsTable').innerHTML;
                document.getElementById('searchResultsFormTable').innerHTML = dashboardTable;
                searchResultsFormSection.style.display = 'block';
            }
            
            dashboardPage.style.display = 'none';
            documentsListPage.style.display = 'none';
            documentTypesPage.style.display = 'none';
            searchResultsSection.style.display = 'none';
            personFormContainer.style.display = 'block';
        }

        document.getElementById('searchResultsTable').addEventListener('click', handleSearchViewBtn);
        document.getElementById('searchResultsFormTable').addEventListener('click', handleSearchViewBtn);

        // FILE UPLOAD
        document.getElementById('fileUpload').addEventListener('change', function(e) {
            console.log('Arquivos selecionados:', this.files.length);
            
            if (this.files.length > 0) {
                const filesToProcess = Array.from(this.files);
                
                filesToProcess.forEach((file, i) => {
                    console.log('Adicionando arquivo:', file.name, file.size, 'bytes');
                    
                    if (file.size > 10 * 1024 * 1024) {
                        showError(`Arquivo ${file.name} √© muito grande (m√°ximo 10MB)`);
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const uploadedFile = {
                            id: Date.now() + i,
                            name: file.name,
                            type: file.type,
                            size: file.size,
                            file: file,
                            dataUrl: e.target.result
                        };
                        
                        uploadedFiles.push(uploadedFile);
                        refreshUploadedFilesList();
                    };
                    reader.readAsDataURL(file);
                });
            }
            
            this.value = '';
        });

        document.getElementById('fileUploadArea').addEventListener('click', function(e) {
            if (e.target.id === 'fileUploadArea' || e.target.tagName === 'P') {
                document.getElementById('fileUpload').click();
            }
        });

        // DRAG AND DROP
        const fileUploadArea = document.getElementById('fileUploadArea');
        
        fileUploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.style.borderColor = 'var(--primary)';
            this.style.backgroundColor = 'rgba(139, 0, 0, 0.1)';
        });
        
        fileUploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            this.style.borderColor = 'rgba(139, 0, 0, 0.3)';
            this.style.backgroundColor = 'rgba(139, 0, 0, 0.02)';
        });
        
        fileUploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            this.style.borderColor = 'rgba(139, 0, 0, 0.3)';
            this.style.backgroundColor = 'rgba(139, 0, 0, 0.02)';
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const fileInput = document.getElementById('fileUpload');
                const dt = new DataTransfer();
                
                for (let i = 0; i < files.length; i++) {
                    dt.items.add(files[i]);
                }
                
                fileInput.files = dt.files;
                fileInput.dispatchEvent(new Event('change'));
            }
        });

        // FILE LIST EVENTS
        document.getElementById('fileList').addEventListener('click', function(e) {
            if (e.target.classList.contains('view-file-btn')) {
                const fileId = parseInt(e.target.getAttribute('data-file-id'));
                console.log('Visualizando arquivo ID:', fileId);
                viewSavedFile(fileId);
            } else if (e.target.classList.contains('download-file-btn')) {
                const fileId = parseInt(e.target.getAttribute('data-file-id'));
                console.log('Fazendo download do arquivo ID:', fileId);
                downloadSavedFile(fileId);
            } else if (e.target.classList.contains('remove-file-btn')) {
                const fileId = parseInt(e.target.getAttribute('data-file-id'));
                console.log('Removendo arquivo ID:', fileId);
                removeSavedFile(fileId);
            } else if (e.target.classList.contains('remove-file')) {
                const index = parseInt(e.target.getAttribute('data-index'));
                uploadedFiles.splice(index, 1);
                refreshUploadedFilesList();
            } else if (e.target.classList.contains('view-uploaded-file')) {
                const index = parseInt(e.target.getAttribute('data-index'));
                const file = uploadedFiles[index];
                if (file) {
                    viewUploadedFile(file);
                }
            }
        });

        // MODAL EVENT LISTENERS
        ['addYearModal', 'addDocTypeModal', 'deleteConfirmModal', 'fileViewModal', 'removeYearModal', 'removeDocTypeModal'].forEach(modalId => {
            const modal = document.getElementById(modalId);
            const closeBtn = modal.querySelector('.modal-close');
            
            if (closeBtn) {
                closeBtn.addEventListener('click', () => {
                    modal.style.display = 'none';
                });
            }
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.style.display = 'none';
                }
            });
        });

        // FILE VIEW MODAL CONTROLS
        document.getElementById('closeFileViewBtn').addEventListener('click', function() {
            document.getElementById('fileViewModal').style.display = 'none';
        });

        document.getElementById('downloadFileBtn').addEventListener('click', function() {
            if (selectedFileForView) {
                downloadFile(selectedFileForView);
            }
        });

        // SAVE BUTTONS
        document.getElementById('saveYearBtn').addEventListener('click', async function() {
            const newYear = parseInt(document.getElementById('newYear').value);
            
            if (newYear && !yearsCache.find(y => y.year === newYear)) {
                try {
                    await addYear(newYear);
                    await initializeYearsGrid();
                    document.getElementById('addYearModal').style.display = 'none';
                    document.getElementById('newYear').value = '';
                    showSuccess('Ano adicionado com sucesso!');
                } catch (error) {
                    console.error('Error adding year:', error);
                }
            } else {
                showError('Ano inv√°lido ou j√° existente!');
            }
        });

        document.getElementById('saveDocTypeBtn').addEventListener('click', async function() {
            const newDocTypeName = document.getElementById('newDocType').value.trim();
            const newDocTypeDesc = document.getElementById('docTypeDescription').value.trim();
            
            if (newDocTypeName && !documentTypesCache.find(t => t.name.toLowerCase() === newDocTypeName.toLowerCase())) {
                const newSlug = newDocTypeName.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
                
                const docTypeData = {
                    name: newDocTypeName,
                    slug: newSlug,
                    description: newDocTypeDesc || `Registros de ${newDocTypeName.toLowerCase()}`,
                    icon: 'document.png'
                };
                
                try {
                    await addDocumentType(docTypeData);
                    await initializeDocumentTypesGrid();
                    document.getElementById('addDocTypeModal').style.display = 'none';
                    document.getElementById('newDocType').value = '';
                    document.getElementById('docTypeDescription').value = '';
                    showSuccess('Tipo de documento adicionado com sucesso!');
                } catch (error) {
                    console.error('Error adding document type:', error);
                }
            } else {
                showError('Nome inv√°lido ou tipo de documento j√° existente!');
            }
        });

        // DELETE CONFIRMATION
        document.getElementById('confirmDeleteBtn').addEventListener('click', async function() {
            if (selectedDocument) {
                const success = await deleteDocument(selectedDocument);
                
                if (success) {
                    await loadDocumentsTable(selectedYear, selectedDocTypeId);
                    document.getElementById('deleteConfirmModal').style.display = 'none';
                    showSuccess('Documento exclu√≠do com sucesso!');
                }
            }
        });

        document.getElementById('cancelDeleteBtn').addEventListener('click', function() {
            document.getElementById('deleteConfirmModal').style.display = 'none';
        });

        // CANCEL BUTTONS
        document.getElementById('cancelYearBtn').addEventListener('click', function() {
            document.getElementById('addYearModal').style.display = 'none';
        });

        document.getElementById('cancelDocTypeBtn').addEventListener('click', function() {
            document.getElementById('addDocTypeModal').style.display = 'none';
        });

        document.getElementById('cancelRemoveYearBtn').addEventListener('click', function() {
            document.getElementById('removeYearModal').style.display = 'none';
        });

        document.getElementById('cancelRemoveDocTypeBtn').addEventListener('click', function() {
            document.getElementById('removeDocTypeModal').style.display = 'none';
        });

        // CLEAR SEARCH
        document.getElementById('clearSearchBtn').addEventListener('click', function() {
            searchResultsSection.style.display = 'none';
            searchInputs.forEach(input => input.value = '');
        });

        document.getElementById('clearSearchFormBtn').addEventListener('click', function() {
            searchResultsFormSection.style.display = 'none';
        });

        // INITIALIZE ON PAGE LOAD
        document.addEventListener('DOMContentLoaded', function() {
            const currentYear = new Date().getFullYear();
            document.getElementById('newYear').value = currentYear;
            console.log('Sistema de gerenciamento paroquial inicializado!');
            console.log('Conectando ao Supabase:', SUPABASE_URL);
        });
    </script>
</body>
</html>

